define("user:widget/index/index-async.js",function(e,t,s){var i=e("common:widget/ui/jquery-ext/jquery-ext.js");e("common:widget/ui/jq-dialog/jq-dialog.js");var a=e("common:widget/ui/lite/lite.js"),o=e("common:widget/ui/eJS/eJS.js"),r=e("common:widget/lib/tangram/ui/Pager/Pager.js"),n=e("user:widget/ui/page-scroll/page-scroll.js"),p=e("person"),d=e("user"),h=e("usercenter"),c={init:function(){this.notesTempate=new o({url:"/static/user/widget/index/notes-card.ejs"}),this.pictravelTempate=new o({url:"/static/user/widget/index/pictravel-card.ejs"}),this.experienceWapper=i("#J_experience-year"),this.years=0,this.cardsInfo={},this.photos={},this.rn=30,this.ajaxSwitch=!0;var e=this;i(p.experience&&p.experience.experience_list).each(function(t,s){if(1>t){var i=s.year;e.getExpInterval(i)}}),h.indexEvent&&(this.eventBind(),h.indexEvent=0)},getExpInterval:function(){var e=this;e._interval=setInterval(function(){return e.years>=p.experience.experience_list.length?void(e._interval&&clearInterval(e._interval)):void(e.ajaxSwitch&&e.getExperience(p.experience.experience_list[e.years].year))},300)},scrollEvent:function(){},getExperience:function(e){var t=this,s=[];t.ajaxSwitch=!1;var o="/user/travels/getexperience?format=ajax&t="+(new Date).getTime();i.get(o,{uid:p.uid,year:e},function(e){var o=e.errno;if(0==o){t.years++;var r=e.data.list;r&&r.length>0&&(i(r).each(function(e,o){switch(t.cardsInfo[o.xid]=o,parseInt(o.type,10)){case 1:s.push(t.notesTempate.render({notes:o,createImage:a.createImage,experience_hidden:1==o.is_hide?"hidden":"display",experience_abstract:i.string.encodeHTML(a.cut(o["abstract"],80).replace(/&nbsp;/g," ")),is_myself:p.is_myself,experience_title:i.string.encodeHTML(o.title),year:a.date("Y",o.start_time),month:a.date("m",o.start_time)}));break;case 2:s.push(t.pictravelTempate.render({pictravel:o,createImage:a.createImage,experience_hidden:1==o.is_hide?"hidden":"display",experience_title:i.string.encodeHTML(o.title),is_myself:p.is_myself,year:a.date("Y",o.start_time),month:a.date("m",o.start_time)}))}}),t.experienceWapper.find("#J_card-blank").before(i(s.join(""))),t.ajaxSwitch=!0)}},"json")},changeCardCovers:function(e){var t=this;this.selectedPid=[],this.selectedDom=[],this.card=e.parents(".experience-card"),this.xid=this.card.attr("data-xid"),this.travels_id=this.card.attr("data-travels_id");var s=this.card.attr("data-type");switch(this.photosWrapper=null,this.cardType=s,this.cardMarginBottom=this.card.css("marginBottom"),this.coverPicLength="notes"==s?1:4,this.photosWrapper||(this.photosWrapper=i(['<div class="card-photos-wrapper" id="J_card-photos-wrapper">','<div class="photos-arrow"></div>','<div class="photos-close"></div>','<div class="photo-header">','<strong class="photos-title">',i.string.encodeHTML(t.cardsInfo[t.xid].title),"</strong>",'<span>已选 <span class="photos-choose J_photos-choose-count">0</span>/<span class="J_photos-count">',t.coverPicLength," </span>张</span>","</div>","notes"==s?'<div class="photos-album J_photos-album"><p class="album-default J_album-default"></p><ul class="album-list" style="display:none"></ul></div>':"",'<div class="photos-list J_photos-list"></div>','<div class="photos-none J_photos-none">暂无图片</div>','<div class="photos-pager J_photos-pager"></div>','<a class="photos-save J_photos-save" href="###">确定</a>',"</div>"].join(""))),s){case"notes":t.getAlbums(t.xid);break;default:t.getPhotos(s,{xid:t.xid})}},getAlbums:function(e){var t=this,s=this.photosWrapper.find(".J_photos-album"),a=s.find(".J_album-default"),o=s.find("ul"),r=[],n="/notes/album/getAlbums?format=ajax";i.get(n,{nid:e},function(e){var n=e.errno;if(0==n){var p=e.data,d=p.list;if(!d.length)return;var h=d[0].pics_count;t.aid=d[0].aid,a.text(d[0].title+" （"+h+"）"),d.length>1?(s.show(),i(d).each(function(e,t){r.push(["<li>",'<a class="',0==e?"current ":"",'J_album_choose" data-aid="',t.aid,'" href="###">',i.string.encodeHTML(t.title)," （",t.pics_count,"）","</a>","</li>"].join(""))}),o.html(r.join(""))):s.hide(),t.getPhotos("notes",{aid:t.aid}),t.renderPhotosPop()}},"json")},getPhotos:function(e,t){var s=this;t=i.extend({pn:0,rn:s.rn},t);var a,o;switch(e){case"notes":a="/notes/photo/getPhotos?format=ajax",o={aid:t.aid||t.xid};break;default:a="/notes/ajax/getpictravelpics?format=ajax",o={ptid:t.xid}}i.extend(o,{pn:t.pn,rn:t.rn}),i.get(a,o,function(e){var t=e.errno;if(0==t){var i=e.data,a=i.pic_list||i.list,o=i.pic_count||i.total;parseInt(o,10)>0?(s.photosWrapper.find(".J_photos-none").hide(),s.renderPhotosList(a)):s.photosWrapper.find(".J_photos-none").show(),s.isPopShow||s.renderPhotosPop(),s.Pager||s.renderPhotosPager(o)}},"json")},renderPhotosList:function(e){var t=this,s=[];i(e).each(function(e,o){if(e<t.rn){var r=o.puid||o.pic_id;!t.photos[r]&&(t.photos[r]=o);var n=i.inArray(r,t.selectedPid);s.push(['<div class="photos-item J_photos-item',-1!=n?" selected":"",'" data-pid="',r,'">','<a href="###">',a.createImage("",o.full_url_300||o.pic_url,o.ext.width,o.ext.height,100,100,!1,!1),'<span class="photo-selected J_photo-select"></span>','<span class="photo-setcover J_photo-setcover">设为卡片封面</span>',"</a>","</div>"].join(""))}}),this.photosWrapper.removeClass(".card-photos-slidedown").find(".J_photos-list").html(i(s.join("")))},renderPhotosSlide:function(e){var t=this;this.card.animate({marginBottom:500},"slow"),this.photosWrapper.addClass(".card-photos-slidedown").removeClass(".photos-wrapper-dialog").find(".photos-wrapper-list").append(e);var s=this.card.offset(),a=this.card.height(),o=this.card.width();this.photosWrapper.css({top:s.top+a+40}),this.photosWrapper.find(".photos-wrapper-arrow").css({left:s.left+o/2}),i("html,body").animate({scrollTop:s.top},"fast"),this.photosWrapper.appendTo(i(body)).show(),this.photosWrapper.delegate(".photos-wrapper-close","click",function(){t.card.animate({marginBottom:t.cardMarginBottom},"slow"),t.photosWrapper.find(".photos-wrapper-list").empty(),t.photosWrapper.hide()})},renderPhotosPop:function(){var e=this;this.photosPop=this.photosWrapper.dialog({modal:!0,width:600,resizable:!1,dialogClass:"photos-wrapper-dialog ui-dialog-notitle",open:function(){e.isPopShow=!0},beforeClose:function(){e.isPopShow=!1,e.Pager.dispose(),e.Pager=null,e.photosWrapper.find(".photos-wrapper-list").empty(),e.photosWrapper&&e.photosWrapper.remove()}})},renderPhotosPager:function(e,t){var s,a=this.photosWrapper.find(".J_photos-pager");s=t&&t.rn||this.rn;var o=Math.ceil(e/s),n=this;this.currentPage=0;var p={beginPage:1,endPage:o,currentPage:1,tplHref:"###",tplLabel:"#{page}",itemCount:6,specialLabelMap:{first:"首页",next:"&gt;",previous:"&lt;"},ongotopage:function(e){n.PhotoListPn=s*(e.page-1),n.currentPage!==e.page-1&&(n.currentPage=e.page-1,n.getPhotos(n.cardType,{pn:n.PhotoListPn,xid:n.xid,aid:n.aid}))}};if(1>=o?a.hide():a.show(),this.Pager){if(1>=o)return;this.Pager.update(p),a.show()}this.Pager=new r(p);var d=a.find(".pager-wrapper");0==d.length&&(d=i('<div class="pager-wrapper"></div>'),d.appendTo(a)),this.Pager.render(d[0]),this.PhotoListPn=0},saveCardCovers:function(){var e=this,t="/user/travels/setcardcover?format=ajax",s="travels_id="+this.travels_id+"&bdstoken="+(d.bdstoken||0);this.selectedPid.length>0?(i(this.selectedPid).each(function(t,i){var a=e.photos[i],o=a.width||a.ext&&a.ext.width,r=a.height||a.ext&&a.ext.height,n=a.url||a.pic_url;s+='&pics[]={"pic_url":"'+n+'","pic_id":"'+i+'","width":'+o+',"height":'+r+"}"}),i.post(t,s,function(t){var s=t.errno;0==s&&(e.isPopShow=!1,e.selectedPid=[],e.photosWrapper.find(".photos-wrapper-list").empty(),e.photosPop.dialog("destroy"),t.data&&t.data.list&&e.changePhotos(t.data.list))},"json")):(e.photosWrapper.find(".photos-wrapper-list").empty(),e.photosPop.dialog("destroy"))},selectPhotos:function(e){for(var t=e.attr("data-pid"),s=-1,a=0;a<this.selectedPid.length;a++)if(this.selectedPid[a]==t){s=a;break}if(s>=0)this.selectedPid.splice(s,1),s=-1;else{if(this.selectedPid.length==this.coverPicLength){var o=this.selectedPid.shift();i(this.photosWrapper).find(".selected[data-pid='"+o+"']").removeClass("selected")}this.selectedPid.push(t)}e.toggleClass("selected"),i(this.photosWrapper).find(".J_photos-choose-count").text(this.selectedPid.length)},changePhotos:function(e){for(var t=0;t<this.coverPicLength;t++){var s=e.length,i=e[s-1];s-1>t&&(i=e[t]);var o=i.full_url_300,r=100,n=100;0==t&&(o=i.full_url_500,r=256,n=300),this.card.find(".card-covers a:eq("+t+")").html(a.createImage("",o,i.width,i.height,n,r,!1,!1))}},eventBind:function(){var e=this;i(document).delegate(".J_card-tool-choose","click",function(){var t=i(this);e.changeCardCovers(t)}),i(document).delegate(".J_photos-item","click",function(){var t=i(this);e.selectPhotos(t)}),i(document).delegate(".J_photos-save","click",function(){var t=i(this);e.saveCardCovers(t)}),i(document).delegate(".J_album-default","click",function(){i(this).next().show()}),i(document).delegate(".J_album_choose","click",function(){var t=i(this);t.parents("ul").find(".current").removeClass("current"),t.parents("ul").hide().prev().text(t.addClass("current").text()),e.Pager.dispose(),e.Pager=null,e.aid=t.attr("data-aid"),e.getPhotos("notes",{aid:e.aid})}),n({$dom:this.experienceWapper,callback:function(){e.scrollEvent()}})}};s.exports=c});
;define("user:widget/remark/pre-remark.js",function(e,r,t){var a=e("common:widget/ui/remark-batch/remark-batch.js"),i=e("common:widget/ui/jquery-ext/jquery-ext.js"),n={go:function(){var r=this.getQueryValue(location.href,"goremark");if(!r||1!=r)return!1;for(var t=e("remark-go-sids"),n=0;n<t.length;n++)t[n]="sids[]="+t[n];var o=t.join("&");i.getJSON("/user/ajax/remark/getbatchremarkbysids?"+o,function(e){0==e.errno&&a({initialScenelist:e.data.list,type:2,isInited:!1,closeCallback:function(){}})})},getQueryValue:function(e,r){var t=new RegExp("(^|&|\\?|#)"+r+"=([^&#]*)(&|$|#)",""),a=e.match(t);return a?a[2]:null}};n.go(),t.exports=n});
;define("user:widget/remark/remark.js",function(e,r,t){var a=e("common:widget/ui/nslog/nslog.js"),n=e("common:widget/ui/remark-content/remark-content.js"),i=e("common:widget/ui/remark-batch/remark-batch.js"),s=e("common:widget/ui/rank/rank.js"),m=e("common:widget/ui/eJS/eJS.js"),o=e("common:widget/ui/jquery-ext/jquery-ext.js"),c=e("person"),d=e("user"),u=function(e){this.isMyself=e.isMyself,this.sugscenelist=null,this.pn=0,this.rn=4,this.remarkItemDoms=o(".ur-item"),this.recommendBtnDom=o(".J_recommend-btn")[0],this.init()};o.extend(!0,u.prototype,{recommendItemTpl:['<a href="/#{surl}/" target="_blank" class="ur-recommend-item">#{sname}</a>'].join(""),URL:{BatchRemarkRecommend:"/user/ajax/remark/getbatchremarkrecommend"},batchRemarkType:2,init:function(){o(this.remarkItemDoms).each(function(e,r){var t=o(r).attr("data-remarkdata");t=JSON.parse(t);var a=new n({remarkFullData:t,onChange:function(){window.location.reload()},isMine:!0}),i=a.render();r.appendChild(i),o(r).removeAttr("data-remarkdata")});var e=new s("/main/event/remark/ajax/getrank","user");if(d.uid==c.uid)var r=!0;else var r=!1;if(e.rankuserremark(o(".userpart")[0],c.uid,r),e.render(o(".listpart")[0]),e.rankmsg("/main/event/remark/feed?t=",o(".feedpart")[0],32,10,!0),this.isMyself){a.nslog(location.href,512,{cmd:"click",pos:"add-remark-show"});var t="/static/user/widget/remark/footprint.ejs";this.footprintTempate=new m({url:t}),this.batchRemark()}},batchRemark:function(){var r=this,t=o("#J_remark-footprint"),n={rn:this.rn,pn:this.pn,type:this.batchRemarkType},s=this.URL.BatchRemarkRecommend;o.get(s,n,function(n){if(0==n.errno&&n.data.list){var s=n.data,m=r.footprintTempate.render({unremark:s.gos_num,scenes:s.list,uid:e("user").uid,percent:parseInt(100*s.rate,10),percentClass:Math.ceil(20*s.rate)});t.html(m),o(".J_recommend-btn").click(function(){a.nslog(window.location.href,511,{cmd:"click",pos:"batch-userpage-click"}),i({initialScenelist:r.sugscenelist,type:r.batchRemarkType,isInited:!1,closeCallback:function(){o(".rb-topbar").remove(),o(".rb-main").remove()},entry:"user"})})}},"json")}}),t.exports=u});
;define("user:widget/pictravel/pictravel-async.js",function(t,e,a){var i=t("common:widget/lib/tangram/base/base.js"),n=t("common:widget/ui/dialog/dialog.js"),r=function(){function e(e,a,n){var r={ptid:e},c="/pictravel/delete";0==a&&(c="/pictravel/delete?isfirst=1"),i.ajax.post(c,i.url.jsonToQuery(r)+"&bdstoken="+(t("user").bdstoken||0),function(t,e){var a=i.json.parse(e);n&&(0===a.errno?n.success():n.fail())})}var a=function(){var t=i.dom.query(".pictravel-main");t&&t.length>0&&i.event.on(t[0],"click",function(t){var a=i.event.getTarget(t),r=a.getAttribute("data-action");switch(r){case"deletePictravel":var c=a.getAttribute("data-ptid"),o=a.getAttribute("data-status"),s={titleText:"删除该图片旅程？",iconStyle:"alert",onaccept:function(){var t=i.dom.getAncestorByClass(a,"card-block");i.dom.remove(t),e(c,o,{success:function(){n.splash(!0)},fail:function(){n.splash(!1)}})}},l="您确认要删除该旅行画册？<br>如果删掉的话，当年的奖金会被要回来的T_T";n.confirm(l,s)}})};a()};a.exports=r});
;define("user:widget/want/want-async.js",function(n,t,e){var o=n("common:widget/ui/jquery/jquery.js"),i=n("common:widget/ui/dialog/dialog.js"),a=n("common:widget/ui/login/login.js"),c=function(){return{init:function(){o(".J_tool-delete").on("click",function(){var t=o(this),e=t.attr("data-sid"),c={titleText:"删除想去",iconStyle:"alert",onaccept:function(){a.check(function(){var a="/user/want/cancel?format=ajax",c="type=1&sid="+e;o.post(a,c+"&bdstoken="+(n("user").bdstoken||0),function(n){0==n.errno?(i.splash(!0),t.parents(".card-block").remove()):703==n.errno?i.alert("对不起，您的旅程中有该目的地。请先在旅程中把它删除。",{iconStyle:"alert"}):i.splash(!1)},"json")})}},r="您确认要删除吗？";i.confirm(r,c)})}}}();e.exports=c});
;define("user:widget/edit-avatar/edit-avatar-async.js",function(a,t,e){var i=a("common:widget/lib/tangram/base/base.js"),v=a("common:widget/ui/form/form.js"),l=a("common:widget/ui/dialog/dialog.js"),r=function(){i.on("lv-user-activate-avatar-edit","click",function(){i.hide("lv-activate-avatar-flash-show"),i.show("lv-activate-avatar-flash-edit")});{var a="lv-activate-avatar-flash-wraper",t="lv-activate-avatar-flash",e="/user/activate/upload?format=ajax";i.g(a)}i.swf.create({id:t,url:"/static/user/flash/avatar-maker.swf?v=1.7",width:576,height:496},a);var r=v.getCallback();window[r]=function(a){var t=i.json.parse(a);0==t.errno?setTimeout(function(){var a="http://hiphotos.baidu.com/lvpics/pic/item/";i.G("lv-avatar-large").src=a+t.data.avatar_large+".jpg",i.G("lv-avatar-middle").src=a+t.data.avatar_large+".jpg",i.hide("lv-activate-avatar-flash-edit"),i.show("lv-activate-avatar-flash-show"),l.splash(!0)},600):(l.splash(!1),alert(a))},i.on("lv-user-activate-avatar-flash-cancel","click",function(){i.hide("lv-activate-avatar-flash-edit"),i.show("lv-activate-avatar-flash-show")}),i.on("lv-user-activate-avatar-flash-submit","click",function(){var a=i.swf.getMovie(t);a?a.upload(e,null,r):l.alert("Flash插件未启用或者Flash加载不成功",{iconStyle:"alert"})})};e.exports=r});
;define("user:widget/edit-info/edit-info-async.js",function(a,e,n){var i=a("common:widget/lib/tangram/base/base.js"),t=a("common:widget/ui/validator/validator.js"),o=a("common:widget/ui/dialog/dialog.js"),l=a("common:widget/ui/cascadeSelect/cascadeSelect.js"),c=function(){function e(n,t){if(!(n>1)){if(a("info").cascadeSelect)var o="/destination/ajax/source?index="+t+"&callback=tmpCallback&format=callback&_t="+(new Date).getTime();else var o="/destination/ajax/source?sid="+t+"&callback=tmpCallback&format=callback&_t="+(new Date).getTime();window.tmpCallback=function(o){if(window.tmpCallback=null,0==o.errno){var r=[],s=[],d=o.data.position.top,u=o.data.second[o.data.position["final"]][1];s.push({text:"-请选择-",value:"-1",children:[]}),i.array.each(o.data.top,function(a,e){s.push(i.lang.isArray(a)?{value:a[1],text:a[0]}:{value:e,text:a})}),r.push(s);var f=[];if(i.array.each(o.data.second,function(a,e){f.push(i.lang.isArray(a)?{value:a[1],text:a[0]}:{value:e,text:a})}),s[d+1].children=f,r.push(f),a("info").cascadeSelect)a("info").cascadeSelect.appendData(n+1,f,c,t);else{var v=1,m=a("info").cascadeSelect=new l({data:s});i.dom.empty(c),m.render(2,{containers:[c,c],defaults:[d,u]}),m.onchange=function(a,n){if(v=a,n.children)n.children.length>=0&&m.appendData(a+1,n.children,c);else{if("-1"==n.value)return;e(a,n.value)}}}}else e(1,"795ac511463263cf7ae3def3")},i.sio.callByBrowser(o)}}var n={self_introduction:{maxlen:60}};infoValidater=t.create(i.g("J_lv-user-edit-info-form"),{rules:n,ajaxsubmit:!0});var c="lv-location-city-select";e(1,a("info").location_sid),i.on("J_lv-user-edit-info-form-submit","click",function(){var e=i.g("J_lv-user-edit-info-form");if(!infoValidater.validAll())return!1;for(var n=a("info").cascadeSelect.getSelectedOptions(),t=n.length,l=n[t-1];!l;)t--,l=n[t-1];var c=l;return"-1"==c.value?(infoValidater.warning(e.location_sid,"empty"),!1):(e.location_sid.value=c.value,e.location.value=c.text,infoValidater.clear(e.location_sid),void i.ajax.form(e,{replacer:function(a){return a},onsuccess:function(a,n){var t=i.json.parse(n);0==t.errno?o.splash(!0):301==t.errno||302==t.errno?(infoValidater.warning(e.nickname,t.errno),e.nickname.focus()):9==t.errno&&o.splash("保存太快，请稍微等一下~"),e=null}}))})};n.exports=c});
;define("user:widget/edit-sns/edit-sns-async.js",function(a,e,n){var t=a("common:widget/lib/tangram/base/base.js"),i=a("common:widget/ui/validator/validator.js"),l=a("common:widget/ui/cascadeSelect/cascadeSelect.js"),o=function(){function e(n,i){if(!(n>1)){if(a("info").cascadeSelect)var c="/destination/source?index="+i+"&callback=tmpCallback&format=callback&_t="+(new Date).getTime();else var c="/destination/source?sid="+i+"&callback=tmpCallback&format=callback&_t="+(new Date).getTime();window.tmpCallback=function(c){if(window.tmpCallback=null,0==c.errno){var r=[],s=[],d=c.data.position.top,u=c.data.second[c.data.position["final"]][1];s.push({text:"-请选择-",value:"-1",children:[]}),t.array.each(c.data.top,function(a,e){s.push(t.lang.isArray(a)?{value:a[1],text:a[0]}:{value:e,text:a})}),r.push(s);var f=[];if(t.array.each(c.data.second,function(a,e){f.push(t.lang.isArray(a)?{value:a[1],text:a[0]}:{value:e,text:a})}),s[d+1].children=f,r.push(f),a("info").cascadeSelect)a("info").cascadeSelect.appendData(n+1,f,o,i);else{var v=1,m=a("info").cascadeSelect=new l({data:s});t.dom.empty(o),m.render(2,{containers:[o,o],defaults:[d,u]}),m.onchange=function(a,n){if(v=a,n.children)n.children.length>=0&&m.appendData(a+1,n.children,o);else{if("-1"==n.value)return;e(a,n.value)}}}}else e(1,"795ac511463263cf7ae3def3")},t.sio.callByBrowser(c)}}var n={self_introduction:{maxlen:60}};infoValidater=i.create(t.g("J_lv-user-edit-info-form"),{rules:n,ajaxsubmit:!0});var o="lv-location-city-select";e(1,a("info").location_sid),t.on("J_lv-user-edit-info-form-submit","click",function(){var e=t.g("J_lv-user-edit-info-form");if(!infoValidater.validAll())return!1;for(var n=a("info").cascadeSelect.getSelectedOptions(),i=n.length,l=n[i-1];!l;)i--,l=n[i-1];var o=l;return"-1"==o.value?(infoValidater.warning(e.location_sid,"empty"),!1):(e.location_sid.value=o.value,e.location.value=o.text,infoValidater.clear(e.location_sid),void t.ajax.form(e,{replacer:function(a){return a},onsuccess:function(a,n){var i=t.json.parse(n);0==i.errno?dialog.splash(!0):301==i.errno||302==i.errno?(infoValidater.warning(e.nickname,i.errno),e.nickname.focus()):9==i.errno&&dialog.splash("保存太快，请稍微等一下~"),e=null}}))})};n.exports=o});
;define("user:widget/favorite/favorite.js",function(t,e,i){var n=t("common:widget/ui/jquery/jquery.js"),s=t("common:widget/ui/dialog/dialog.js"),o=t("common:widget/ui/errno/errno.js"),r=t("user"),d={init:function(t){this.opts=n.extend({tbody:"",deleteBtn:"",uid:"",acitonSrc:"/user/favorite",delFavoriteAction:"/user/favorite/delete?format=ajax",VAR_page_owner:"",TOTAL_NUM:"",perPageNum:5,uiUpdate:""},t),this.tbodyId=this.opts.tbody,this.container=n("#"+this.opts.container),this.totalNumWrap=n("#"+this.opts.totalNumWrap),this.deleteBtn=n("."+this.opts.deleteBtn),this.MAX_DEL_NUM="",this.MAX_DEL_NUM=this.container.find("tbody").find("tr").length;var e=this;e.deleteBtn.disabled=!1,n(e.deleteBtn).on("click",function(t){e.deleteAjax(),t.preventDefault()})},deleteAjax:function(){var t=this;if(this.results=this.getNeedDeleteId(),this.results.index.length>0){this.deleteBtn.disabled=!0;var e={fids:this.results.fids,uid:this.opts.uid,bdstoken:r.bdstoken||0,stamp:(new Date).getTime()};n.post(this.opts.delFavoriteAction,e,function(e){0==e.errno?(t.onDelSuccess(e),s.splash(!0)):t.onError(e),t.deleteBtn.disabled=!1},"json")}else s.alert("对不起您还未选择需要删除的收藏",{iconStyle:"alert"})},onDelSuccess:function(){this.results.index.length>=this.MAX_DEL_NUM?this.opts.uiUpdate():this.delCurrentItem()},delCurrentItem:function(){for(var t=this.container.find("tbody"),e=t.find("tr"),i=this.results.index,s=this.totalNumWrap.innerHTML;i.length;){var o=i.pop();n(e[o]).fadeOut(200,function(){t[0].deleteRow(o)}),this.MAX_DEL_NUM--,s--}this.updateTotalNum(s)},getNeedDeleteId:function(){var t=n(".J-itemCheckbox"),e=[],i=[];return n(t).each(function(t,n){n.checked&&(e.push(n.value),i.push(n.parentNode.parentNode.sectionRowIndex))}),{fids:e,index:i}},updateTotalNum:function(t){this.totalNumWrap.innerHTML=t},onError:function(t){o.check(t)}};i.exports=d});
;define("user:widget/footprint-list/footprint-list.js",function(t,e,a){var i=t("common:widget/ui/jquery/jquery.js"),s=(t("user:widget/ui/drawer/drawer.js"),t("user:widget/ui/mercatorProjection/mercatorProjection.js"),t("common:widget/ui/jq-dialog/jq-dialog.js"),t("common:widget/ui/lite/lite.js")),n=t("user:widget/ui/updateData/updateData.js"),r=t("user:widget/ui/city-suggestion/city-suggestion.js"),o=t("common:widget/ui/remark-batch/remark-batch.js"),c=t("common:widget/ui/nslog/nslog.js");t("common:widget/ui/jquery-ext/jquery-ext.js"),t("common:widget/ui/jq-scrollspy/jq-scrollspy.js");var d=t("common:widget/ui/eJS/eJS.js"),l=t("person"),p=t("user"),m=t("usercenter"),f={init:function(){var t=this;this.batchRemarkNumber=0,this.renderCityHTML=new d({url:"/static/user/widget/footprint-list/city-list.ejs"}),this.renderSceneHTML=new d({url:"/static/user/widget/footprint-list/scene-list.ejs"}),this.addScene=i(".J_operation-text"),this.cardList=i(".scene-card-list"),this.scrollElement=i(window).on("scroll",function(){t.fixTimeline.call(t)}),this.datelist=i(".dest-list-navigation"),this.cityPosition={},i(".footprint-city").each(function(e,a){t.cityPosition[i(a).attr("data-sid")]=i(a).offset().top}),this.listHeight=i(window).height()-i(".public-header").height()||0,this.scrollTop=0,this.isClick=!0,i(window).width()<1280&&i(".dest-list-navigation").hide(),m.footprintEvent&&(this.bindEvent(),m.footprintEvent=0)},fixTimeline:function(){var t=i(".footprint-main"),e=i(".china-list .footprint-list");if(0!=t.length&&0!=e.length){var a=this.scrollElement.scrollTop(),s=i(".china-list .footprint-list").offset().top-17,n=this.datelist.css("position");a>s&&"absolute"===n?this.datelist.css({position:"fixed",top:70,left:i(".footprint-main").offset().left-120}):s>a&&"fixed"===n&&this.datelist.css({position:"absolute",top:50,left:-120})}},bindEvent:function(){var t=this;i(document).delegate(".J_scene-get-more-gone","click",function(){i(this).hasClass("get-less-gone")?(i(this).parent().parent().height(18),i(this).removeClass("get-less-gone")):(i(this).parent().parent().css("height","auto"),i(this).addClass("get-less-gone"))}),i(document).delegate(".J_footprint-stamp","mouseenter",function(){var t=parseInt(i(this).attr("percent"),10);if(1>t){var e=i(this).next(".footprint-data").width();if(160>e)e=160,i(this).find(".info-desc-content").css("width",e+"px");else{var a=(e-160)/2+10;e+=a,i(this).find(".info-desc-content").css("width",e+"px")}i(this).find(".info-desc").css("display","block")}}),i(document).delegate(".go-remark","click",function(e){var a=i(this).attr("data-sid"),s={sid:a,uid:p.uid,bdstoken:p.bdstoken,pn:0,rn:10};t.addSceneDom=i(this).parents(".footprint-city"),setTimeout(function(){i.get("/user/ajax/getfootprintscenes?format=ajax",s,function(e){t.scenelist=e.data.remark_list||[],t.sugScenelist=e.data.ext_list||[];var s=e.data.remark_total||0;if(i(t.scenelist).each(function(t,e){e.img_url="http://hiphotos.baidu.com/lvpics/pic/item/"+e.pic_url+".jpg"}),i(t.sugScenelist).each(function(t,e){e.img_url="http://hiphotos.baidu.com/lvpics/pic/item/"+e.pic_url+".jpg"}),s>10)var n={sid:a,uid:p.uid,initialScenelist:t.scenelist,GetSuggestedURL:"/user/ajax/getfootprintscenes",type:1,module:"user",closeCallback:function(){t.stampAnimation(),i(".rb-topbar").remove(),i(".rb-main").remove()},callback:function(e,a){t.dealRemarkData(e,a)},isInited:!1};else if(t.sugScenelist)var n={sid:a,initialScenelist:t.sugScenelist,remarkSceneList:t.scenelist,module:"user",closeCallback:function(){t.stampAnimation(),i(".rb-topbar").remove(),i(".rb-main").remove()},callback:function(e,a){t.dealRemarkData(e,a)},isInited:!1};c.nslog(window.location.href,511,{cmd:"click",pos:"batch-footprint-show"}),o(n)},"json")},800),e.preventDefault()}),i(document).delegate(".J_scene-remark-edit","click",function(){i(this).parents(".all-footprint-list").find(".edit-remark").remove(),i(this).parents(".all-footprint-list").find(".scene-card").show(),c.nslog(window.location.href,511,{cmd:"click",pos:"scene-remark-edit"});var t=i(this).attr("remark-id");remarkText="",unavailable="",remarkInfoContent=i(this).prev().prev(".remark-info-content"),sceneName=remarkInfoContent.find(".scene-sname").html(),style=remarkInfoContent.find(".scene-remark-score-star").attr("style"),sceneCard=i(this).parents(".scene-card"),saveData="data-sid="+sceneCard.attr("data-sid"),t&&(remarkText=i(this).prev().attr("title")),t?saveData="remark-id="+t:unavailable="remark-submit-unavailable";var e=['<div class="edit-remark">','<div class="remark-info">','<span class="edit-title">'+sceneName+"</span>",'<div class="edit-score J_edit-score"><div class="scene-remark-score-star" style="'+style+'"></div></div>',"</div>",'<textarea class="remark-content" rows="5">'+remarkText+"</textarea>",'<div class="remark-content-tip"></div>','<div class="remark-operation"><a href="#" class="remark-cancel">取消</a><input type="button" class="remark-save '+unavailable+'" value="保存" '+saveData+"></div>","</div>"];sceneCard.after(e.join("")),sceneCard.hide()}),i(document).delegate(".J_edit-score","click",function(e){var a=e.offsetX||t.getOffset(e).offsetX,s=Math.ceil(a/13),n="width:"+13*s+"px;background-position:0 "+(12*s-60)+"px";i(this).find(".scene-remark-score-star").attr("style",n)}),i(document).delegate(".remark-cancel","click",function(t){var e=i(this).parents(".edit-remark"),a=i(e).prev(".scene-card");e.remove(),a.show(),t.preventDefault()}),i(document).delegate(".remark-save","click",function(e){var a=this,s=i.trim(i(".remark-content").val()).length;if(15>s||s>300)return t.tipWordsLen(),e.preventDefault(),!1;var n=i(".J_edit-score").find(".scene-remark-score-star").width();if(0==n)return t.tipScore(),e.preventDefault(),!1;if(i(this).attr("data-sid")){var r=n/13,o={type:1,word:i(".remark-content").val(),score:r,xid:i(this).attr("data-sid"),format:"ajax",t:(new Date).getTime(),bdstoken:p.bdstoken,from:3};i.post("/user/ajax/remark/addremark",o,function(s){if(0==s.errno){var n=s.data;editRemark=i(a).parents(".edit-remark"),sceneCard=i(editRemark).prev(".scene-card"),remarkText=sceneCard.find(".scene-remark-text"),remarkEdit=sceneCard.find(".J_scene-remark-edit"),scoreStar=sceneCard.find(".scene-remark-score-star"),contentValue=i.string.encodeHTML(i(".remark-content").val()),footprintCity=i(a).parents(".footprint-city"),remarkNumber=footprintCity.find(".remark-total").find("span"),infoNumber=footprintCity.find(".info-number"),stampBackground=footprintCity.find(".stamp-background"),percent=footprintCity.find(".J_footprint-stamp").attr("percent"),remarkCount=parseInt(footprintCity.find(".J_footprint-stamp").attr("remarks"),10),needRemark=parseInt(footprintCity.find(".J_footprint-stamp").attr("need-remarks"),10),newPercent=(remarkCount+1)/(needRemark+remarkCount),stampScore=footprintCity.find(".stamp-score"),needRemarkNumber=parseInt(infoNumber.html(),10)-1,0==needRemark?(newPercent=1,footprintCity.find(".J_footprint-stamp").attr("need-remarks",0)):footprintCity.find(".J_footprint-stamp").attr("need-remarks",needRemark-1),footprintCity.find(".J_footprint-stamp").attr("remarks",remarkCount+1),newPercent=newPercent>1?1:parseFloat(newPercent.toFixed(1)),infoNumber.html(needRemarkNumber>0?needRemarkNumber:0),remarkNumber.html(parseInt(remarkNumber.html(),10)+1),scoreStar.css("width",13*r+"px"),scoreStar.css("backgroundPosition","0 "+(12*r-60)+"px"),remarkEdit.attr("remark-id",n.remark.remark_id),remarkText.attr("title",contentValue),remarkText.html(contentValue.length>25?"“"+contentValue.substr(0,25)+"...”":"“"+contentValue+"”"),editRemark.remove(),sceneCard.show(),setTimeout(function(){t.getStampBackground(stampBackground,"stamp-img-",10*percent,10*newPercent)},40),1==newPercent&&0!=needRemark&&setTimeout(function(){stampScore.after('<div class="footprint-postmark"></div>');var e=stampScore.next(".footprint-postmark");t.getPostMarkAnimation(e,"footprint-postmark-",0)},500),footprintCity.find(".J_footprint-stamp").attr("percent",newPercent),stampScore.html(1!=newPercent?100*newPercent+"%":""),e.preventDefault()}},"json")}else{var r=n/13,o={type:1,word:i(".remark-content").val(),score:r,remark_id:i(this).attr("remark-id"),format:"ajax",t:(new Date).getTime(),bdstoken:p.bdstoken};i.post("/user/ajax/remark/updremark",o,function(t){if(0==t.errno){var s=i(a).parents(".edit-remark"),n=i(s).prev(".scene-card"),r=n.find(".scene-remark-text"),o=i.string.encodeHTML(i(".remark-content").val());r.attr("title",o),r.attr("title","“"+o+"”"),r.html(o.length>25?"“"+o.substr(0,25)+"...”":"“"+o+"”"),s.remove(),n.show(),e.preventDefault()}},"json")}}),i(document).delegate(".J_arrow","click",function(){var t=this;if(i(this).toggleClass("arrow-more"),i(this).hasClass("arrow-more"))i(this).parent().next().animate({height:0},500,"",function(){i(t).parent().next().hide()});else{var e=i(this).parent().next().css("height","auto").height();i(this).parent().next().css("height","0"),i(this).parent().next().show(),i(this).parent().next().animate({height:e},500)}}),i(document).delegate(".remark-content","keyup",function(){t.tipWordsLen()}),i(document).delegate(".J_footprint-stamp","mouseleave",function(){i(this).find(".info-desc").css("display","none")}),i(document).delegate(".J_get-more","click",function(){var e=i(this).parent().prev(),a=e.find(".scene-card"),s=a.length;if(i(this).attr("src").indexOf("get-more")>-1){var n="http://lvyou0.bdimg.com/static/user/widget/footprint-list/img/get-less_ae90224.png";i(this).attr("src",n);var r=i(this).parent().parent().attr("data-sid"),o={uid:l.uid,pn:s,rn:100,sid:r};i.get("/user/ajax/getfootprintbysid",o,function(a){if(0==a.errno){var i=a.data.list;i.parent_sid=r,e.height("auto"),t.renderSceneList(i)}},"json")}else{var c=i(this).parent().prev(),d=c.find(".scene-card");i(d).each(function(t,e){t>7&&i(e).remove()});var n="http://lvyou4.bdimg.com/static/user/widget/footprint-list/img/get-more_c735c2b.png";i(this).attr("src",n),e.height("400px");var p=i(this).parent().prev().offset().top;i("body,html").animate({scrollTop:p-200},0)}}),i(document).delegate(".J_operation-text","click",function(){if(t.isClick){i(this).hasClass("text-exist")?c.nslog(window.location.href,511,{cmd:"click",pos:"operation-add-exist"}):c.nslog(window.location.href,511,{cmd:"click",pos:"operation-add-new"}),t.isClick=!1;var e=this,a={is_alien:0,format:"ajax",t:(new Date).getTime(),city_sid:i(this).attr("city-sid")};t.addSceneDom=i(this).parents(".footprint-city"),i.get("/destination/ajax/getfootprintdests",a,function(s){if(0==s.errno){var n=s.data.list,r=s.data.parent_sname;r||(r=i(e).parent(".footprint-operation").prev().find(".sub-sname").html());var o=a.city_sid;t.renderScene(n,r,o),t.isClick=!0}},"json")}}),i(document).delegate(".create-new-scene","click",function(e){e.preventDefault();var a=i(this).offset().left-i(window).scrollLeft()-210,s=i(this).offset().top-i(window).scrollTop()-175,n=i(this).parents(".check-default-sid").find(".parent-sname").html(),r=i(['<div class="create-content"><label for="scene-name" class="scene-text">景点名称：</label>','<input type="text" id="scene-name">','<span class="scene-belong">所属：'+n+"</span>",'<span class="add-tip">哦~你好像还没有添加内容啊</span>',"</div>"].join(""));r.dialog({modal:!0,closeOnEscape:!1,draggable:!1,width:270,height:170,position:[a,s],dialogClass:"",close:function(){i(this).remove()},buttons:{"添加":function(){var e=i("#scene-name").val(),a=this;if(e){if(0==t.alien)var s=1;else var s=0;var n={sname:e,parent_sid:t.addParentSid,scene_layer:5,is_china:s,bdstoken:p.bdstoken};c.nslog(window.location.href,511,{cmd:"click",pos:"add-user-scene"}),i.post("/user/ajax/adduserscene",n,function(t){if(0==t.errno){var s='<a href="##" class="go-status J_scene-status scene-click" data-sid='+t.data.data.sid+" title="+i.string.encodeHTML(e)+">"+i.string.encodeHTML(e)+"</a>";i(".city-list").prepend(s);var n=parseInt(i(".J_scene-number").html(),10);i(".J_scene-number").html(n+1),i(a).remove()}},"json")}else i(".add-tip").show()}}})}),i(document).delegate(".scene-card","mouseenter",function(){i(this).parents(".scene-card-list").siblings(".city-delete-button").hide(),i(this).find(".scene-delete-button").show()}),i(document).delegate(".scene-card","mouseleave",function(){i(this).find(".scene-delete-button").hide()}),i(document).delegate(".scene-delete-button","click",function(){var e=i(this).parent(),a=i(this).prev().attr("remark-id"),s={sid:e.attr("data-sid"),bdstoken:p.bdstoken},r=i(['<div class="delete-scene">','<span class="delete-content">你确定要删除该景点吗？</span>',"</div>"].join(""));r.dialog({modal:!0,closeOnEscape:!1,draggable:!1,width:270,height:170,dialogClass:"",close:function(){i(this).remove()},buttons:{"确定":function(){i(this).remove(),i.post("/footprint/post/delete?format=ajax",s,function(s){if(0==s.errno){var r=i(e).parents(".footprint-city");e.remove();var o=r.find(".scene-total").find("span");if(o.html(parseInt(o.html(),10)-1),a){var c=r.find(".stamp-background"),d=r.find(".J_footprint-stamp").attr("percent"),l=r.find(".info-number"),p=parseInt(r.find(".J_footprint-stamp").attr("remarks"),10),m=parseInt(r.find(".J_footprint-stamp").attr("need-remarks"),10),f=parseFloat(((p-1)/(m+p)).toFixed(1)),u=r.find(".stamp-score"),h=r.find(".remark-total").find("span");h.html(parseInt(h.html(),10)-1),0==m?(f=1,r.find(".J_footprint-stamp").attr("need-remarks",0)):r.find(".J_footprint-stamp").attr("need-remarks",m+1),r.find(".J_footprint-stamp").attr("remarks",p-1),setTimeout(function(){t.getStampBackground(c,"stamp-img-",10*d,10*f)},40),r.find(".J_footprint-stamp").attr("percent",f),u.html(1!=f?100*f+"%":"");var g=parseInt(l.html(),10)+1;l.html(g>0?g:0)}var v=r.find(".scene-card");0==v.length&&(r.siblings(".footprint-operation").find(".J_operation-text").removeClass("text-exist").html("添加我去过的景点"),r.find(".scene-card-list").remove()),n.deleteScene()}},"json")},"取消":function(){i(this).remove()}}})}),i(document).delegate(".footprint-city","mouseenter",function(){i(this).find(".city-delete-button").show()}),i(document).delegate(".footprint-city","mouseleave",function(){i(this).find(".city-delete-button").hide()}),i(document).delegate(".city-delete-button","click",function(){var t=i(this).parent(),e=t.find(".sub-sname").html(),a=t.find(".scene-card"),s=i(this).parents(".footprint-item"),r=i(this).parents(".china-list"),o={title:e,scene_length:a.length},c=t.attr("data-sid"),d={sid:c,bdstoken:p.bdstoken},l=i(['<div class="delete-city">','<span class="delete-content">删除城市将会同时删除下面的足迹，确认删除吗？</span>',"</div>"].join(""));l.dialog({modal:!0,closeOnEscape:!1,draggable:!1,width:270,height:170,dialogClass:"",close:function(){i(this).remove()},buttons:{"确定":function(){i(this).remove(),i.post("/footprint/post/delete?format=ajax",d,function(e){if(0==e.errno){t.remove();var a=s.find(".footprint-city");if(0==a.length){var c=s.find(".parent-sname").html(),d=s.attr("id");o.parent_title=c,o.parent_sid=d,s.remove(),i(".list-city[data-sid="+d+"]").parent().remove()}o.alien=0!=r.length?0:1,i(window).scrollspy("refresh"),n.deleteCity(o)}},"json")},"取消":function(){i(this).remove()}}})}),i(document).delegate(".J_scene-status","click",function(t){t.preventDefault();var e=i(".scene-click").length;i(this).toggleClass("scene-click");var a=i(".scene-click").length,s=a-e,n=parseInt(i(".J_scene-number").html(),10);i(".J_scene-number").html(n+s)}),i(document).delegate(".J_gone-status","click",function(t){t.preventDefault()}),i(document).delegate(".list-city","click",function(){i(".dest-list-navigation").find("li").removeClass("datelist-on"),i(this).parent().addClass("datelist-on");var t=i(this).attr("data-sid"),e=i(".footprint_parent_"+t).offset().top-124,a=i(".china-list .footprint-list").offset().top;a>e&&(e+=40),i("body,html").animate({scrollTop:e},0)}),i(document).delegate(".J_add-all-scene","click",function(){var e=i("#J_city-input").find(".scene-click"),a=i("#J_city-input").attr("parent-sid"),s=[];i(e).each(function(t,e){s.push(i(e).attr("data-sid"))});var n={sids:s,bdstoken:p.bdstoken};0!=s.length&&i.post("/footprint/post/save?format=ajax",n,function(e){if(0==e.errno){i("#J_city-input").remove();var s=e.data,n=-1,r=[];i(s.list).each(function(t,e){4==parseInt(e.scene_layer,10)?(s.parent_sid=e.sid,s.parent_sname=e.sname,n=t):parseInt(e.scene_layer,10)>4&&r.push(e)}),s.list=r,t.addSceneList(s),setTimeout(function(){var e={sid:a,uid:p.uid,bdstoken:p.uid};i.get("/user/ajax/getfootprintscenes?format=ajax",e,function(e){if(t.scenelist=e.data.remark_list||[],t.sugScenelist=e.data.ext_list||[],0!=t.scenelist.length||0!=t.sugScenelist.length){var s=e.data.remark_total||0;if(i(t.scenelist).each(function(t,e){e.img_url="http://hiphotos.baidu.com/lvpics/pic/item/"+e.pic_url+".jpg"}),i(t.sugScenelist).each(function(t,e){e.img_url="http://hiphotos.baidu.com/lvpics/pic/item/"+e.pic_url+".jpg"}),s>10)var n={sid:a,uid:p.uid,initialScenelist:t.scenelist,GetSuggestedURL:"/user/ajax/getfootprintscenes",type:1,module:"user",closeCallback:function(){t.stampAnimation(),i(".rb-topbar").remove(),i(".rb-main").remove()},callback:function(e,a){t.dealRemarkData(e,a)},isInited:!1};else var n={sid:a,initialScenelist:t.sugScenelist,remarkSceneList:t.scenelist,module:"user",closeCallback:function(){t.stampAnimation(),i(".rb-topbar").remove(),i(".rb-main").remove()},callback:function(e,a){t.dealRemarkData(e,a)},isInited:!1};c.nslog(window.location.href,511,{cmd:"click",pos:"batch-footprint-show"}),o(n)}},"json")},800)}},"json")}),i(n).on("add",function(e,a){t.addCityList(a)})},getOffset:function(t){var e=this,a=t.target;void 0==a.offsetLeft&&(a=a.parentNode);var i=e.getPageCoord(a),s={x:window.pageXOffset+t.clientX,y:window.pageYOffset+t.clientY},n={offsetX:s.x-i.x,offsetY:s.y-i.y};return n},getPageCoord:function(t){for(var e={x:0,y:0};t;)e.x+=t.offsetLeft,e.y+=t.offsetTop,t=t.offsetParent;return e},dealRemarkData:function(t,e){var a=this,s=this.addSceneDom.find(".scene-card"),n=t.sid,r=!1;if(i(s).each(function(e,a){if(n==i(a).attr("data-sid")){var s=i(a),o=s.find(".scene-remark-text"),c=s.find(".J_scene-remark-edit"),d=s.find(".scene-remark-score-star"),l=s.find(".remark-total").find("span"),p=t.score;contentValue=i.string.encodeHTML(t.content),r=!0,l.html(parseInt(l.html(),10)+1),d.css("width",13*p+"px"),d.css("backgroundPosition","0 "+(12*p-60)+"px"),c.attr("remark-id",t.remark_id),o.attr("title","“"+contentValue+"”"),o.html(contentValue.length>25?"“"+contentValue.substr(0,25)+"...”":contentValue)}}),!r){var o={sids:[n],bdstoken:p.bdstoken},c=t;i.post("/footprint/post/save?format=ajax",o,function(t){if(0==t.errno){var e=t.data,s=-1,n=[];i(e.list).each(function(t,a){4==parseInt(a.scene_layer,10)?(e.parent_sid=a.sid,e.parent_sname=a.sname,s=t):parseInt(a.scene_layer,10)>4&&n.push(a)}),e.list=n,i(e.list).each(function(t,e){e.remark_text=c.content,e.score=c.score,e.remark_id=c.remark_id}),a.addSceneList(e)}},"json")}e&&a.batchRemarkNumber++},stampAnimation:function(){var t=this,e=this.addSceneDom;i("body,html").animate({scrollTop:t.addSceneDom.offset().top-120},0),setTimeout(function(){var a=e.find(".stamp-background"),i=parseFloat(e.find(".J_footprint-stamp").attr("percent"));if(1!=i){var s=e.find(".info-number"),n=parseInt(e.find(".J_footprint-stamp").attr("remarks"),10),r=parseInt(e.find(".J_footprint-stamp").attr("need-remarks"),10),o=(n+t.batchRemarkNumber)/(r+n);o=o>1?1:parseFloat(o.toFixed(1));var c=e.find(".stamp-score");setTimeout(function(){t.getStampBackground(a,"stamp-img-",10*i,10*o)},40),e.find(".J_footprint-stamp").attr("percent",o),c.html(1!=o?100*o+"%":"");var d=parseInt(s.html(),10)-t.batchRemarkNumber;s.html(d>0?d:0),o>=1&&setTimeout(function(){c.after('<div class="footprint-postmark"></div>');var e=c.next(".footprint-postmark");t.getPostMarkAnimation(e,"footprint-postmark-",0)},500)}},300)},getStampBackground:function(t,e,a,i){var s=this;i>a&&(t.removeClass(e+a).addClass(e+(a+1)),setTimeout(function(){s.getStampBackground(t,e,a+1,i)},40))},getPostMarkAnimation:function(t,e,a){var i=this;9>a&&(t.addClass(e+a).removeClass(e+(a-1)),setTimeout(function(){i.getPostMarkAnimation(t,e,a+1)},50))},tip:function(t){var t=t||"";i(".remark-content-tip").html(t),i(".remark-content-tip").show()},tipScore:function(){this.tip('<span class="light">咦，你好像还没有点评分数啊</span>')},tipWordsLen:function(){var t=i.trim(i(".remark-content").val()).length;15>t?(i(".remark-save").hasClass("remark-submit-unavailable")||i(".remark-save").addClass("remark-submit-unavailable"),this.tip('<span class="light">至少还需输入</span><span class="herounit">'+(15-t)+'</span><span class="light">字</span>')):t>300?(i(".remark-save").hasClass("remark-submit-unavailable")||i(".remark-save").addClass("remark-submit-unavailable"),this.tip('<span class="light">已超过</span><span class="herounit">'+(t-300)+'</span><span class="light">字</span>')):(i(".remark-save").hasClass("remark-submit-unavailable")&&i(".remark-save").removeClass("remark-submit-unavailable"),this.tip('<span class="light">还可以输入</span><span class="loseunit">'+(300-t)+'</span><span class="light">字</span>'))},addCityList:function(t){var e=this,a="",n="";if(i(t.list).each(function(n,r){if(r.parent_sid=r.sid,r.need_remark=r.need_remarks||0,r.pic_width=r.ext&&r.ext.width||0,r.pic_height=r.ext&&r.ext.height||0,r.scene_total=r.scene_total||0,r.remark_total=r.remark_total||0,r.parent_sname=t.parent_sname,r.pic_url)r.img=s.createImage("/"+r.surl,r.pic_url,r.pic_width,r.pic_height,82,65,!0,!1);else{var o="http://lvyou3.bdimg.com/static/user/img/no-postmark-pic_9c1f44c.png";r.img='<img src="'+o+'">'}r.sname=i.string.encodeHTML(r.sname),0==r.need_remark?(r.stamp_score="",r.stamp_img="stamp-img-10",r.percent="1",r.postmark='<div class="footprint-postmark-8 footprint-postmark"></div>'):(r.stamp_score="0%",r.percent="0",r.stamp_img="stamp-img-0",r.postmark=""),a+=e.renderCityHTML.render(r)}),n+='<li><div class="list-city J-spy" data-sid="'+t.parent_sid+'" href="#'+t.parent_sid+'">'+t.parent_sname+"</div></li>",0==i(".footprint_parent_"+t.parent_sid).length){if(1==t.alien){var r=i(".world-list .footprint-list");if(0!=r.length)i(".world-list-city ul").prepend(n);else{i(".world-list-city ul").prepend(n);var o='<div class="world-list"><h1 class="list-title">国外|WORLD</h1><div class="footprint-list"></div>';i(".footprint-main").append(o),r=i(".world-list .footprint-list")}}else{var r=i(".china-list .footprint-list");if(0!=r.length)i(".china-list-city ul").prepend(n);else{i(".china-list-city ul").prepend(n);var o='<div class="china-list"><h1 class="list-title">国内|CHINA</h1><div class="footprint-list"></div>';i(".footprint-main").append(o),r=i(".china-list .footprint-list")}}a='<div class="footprint-item" id='+t.parent_sid+'><div class="parent-sname">'+t.parent_sname+'</div><ul class="footprint_parent_'+t.parent_sid+' clearfix">'+a+"</ul></div>",r.prepend(a)}else i(".footprint_parent_"+t.parent_sid).prepend(a)},renderSceneList:function(t){var e=this,a="";i(t).each(function(t,i){if(i.width=13*i.remark_score,i.backgroundWidth=12*i.remark_score-60,i.remark_word)i.remark_text='<span class="scene-remark-text" title="'+i.remark_word+'">“'+i.remark_word.substr(0,25)+"”</span>";else{var n="http://lvyou4.bdimg.com/static/user/widget/footprint-list/img/no-remark-img_2d7faf2.png";i.remark_text='<span class="scene-remark-text"><img src="'+n+'" class="no-remark-img"/>写点什么吧~</span>'}if(i.pic_width=i.ext&&i.ext.width||0,i.pic_height=i.ext&&i.ext.height||0,i.pic_url)i.img=s.createImage("/"+i.surl,i.pic_url,i.pic_width,i.pic_height,200,120,!0,!1);else{var n="http://lvyou3.bdimg.com/static/user/img/no-pic_95c6c69.png";i.img=i.surl?'<a target="_blank" href="/'+i.surl+'"><img src="'+n+'"/></a>':'<img src="'+n+'"/>'}i.sname>7?(i.full_sname=i.sname,i.sname=i.sname.substr(0,7)+"..."):i.full_sname=i.sname,a+=e.renderSceneHTML.render(i)});var n=i(".footprint_"+t.parent_sid+" .scene-card-list");0!=n.length?n.append(a):(i(".footprint_"+t.parent_sid+" .footprint-operation .J_operation-text").addClass("text-exist").html("+继续添加景点"),i(".footprint_"+t.parent_sid+" .footprint-operation").after("<div class='scene-card-list'><div class='card-list-top'></div>"+a+"</div>"))},addSceneList:function(t){var e=this,a=e.addSceneDom.find(".scene-total").find("span"),n=e.addSceneDom.find(".remark-total").find("span"),r=0;a.html(parseInt(a.html(),10)+t.list.length);var o="";i(t.list).each(function(t,a){a.remark_score?(r++,a.width=13*a.remark_score,a.backgroundWidth=12*a.remark_score-60):(a.width=0,a.backgroundWidth=-60);var n="http://lvyou4.bdimg.com/static/user/widget/footprint-list/img/no-remark-img_2d7faf2.png";if(a.remark_text=a.remark_word?'<span class="scene-remark-text" title="'+a.remark_word+'">'+a.remark_word.substr(0,25)+"</span>":'<span class="scene-remark-text"><img src="'+n+'" class="no-remark-img"/>写点什么吧~</span>',a.pic_width=a.ext&&a.ext.width||0,a.pic_height=a.ext&&a.ext.height||0,a.pic_url)a.img=s.createImage("/"+a.surl,a.pic_url,a.pic_width,a.pic_height,200,120,!0,!1);else{var n="http://lvyou3.bdimg.com/static/user/img/no-pic_95c6c69.png";a.img=a.surl?'<a target="_blank" href="/'+a.surl+'"><img src="'+n+'"/></a>':'<img src="'+n+'"/>'}a.sname>7?(a.sname=i.string.encodeHTML(a.sname),a.full_sname=a.sname,a.sname=a.sname.substr(0,7)+"..."):(a.sname=i.string.encodeHTML(a.sname),a.full_sname=a.sname),o+=e.renderSceneHTML.render(a)}),n.html(parseInt(n.html(),10)+r);var c=i(".footprint_"+t.parent_sid+" .scene-card-list");0!=c.length?(c.prepend(o),c.prepend(i(".footprint_"+t.parent_sid+" .scene-card-list .card-list-top"))):(i(".footprint_"+t.parent_sid+" .footprint-operation .J_operation-text").addClass("text-exist").html("+继续添加景点"),i(".footprint_"+t.parent_sid+" .footprint-operation").after("<div class='scene-card-list'><div class='card-list-top'></div>"+o+"</div>"),c=i(".footprint_"+t.parent_sid+" .scene-card-list"));var d=i(c).find(".scene-card").length,l=i(c).parent().find(".J_get-more").length;if(d>8&&0==l){var p="http://lvyou4.bdimg.com/static/user/widget/footprint-list/img/get-more_c735c2b.png";c.height("400px");var m=c.find(".scene-card");i(m).each(function(t,e){t>7&&i(e).remove()}),i(".footprint_"+t.parent_sid+" .get-more").append('<img src="'+p+'" class="J_get-more"/>')}},renderScene:function(t,e,a){var s=this,n="",o="",c=0;if(i(t).each(function(t,e){e.is_gone?(c+=e.sname.length,o+="<a href='##' class='gone-status J_gone-status'>"+e.sname+"</a>"):n+="<a href='##' class='go-status J_scene-status' data-sid='"+e.sid+"' title="+e.sname+">"+e.sname+"</a>"}),c>30)var d='<div class="get-more"><div class="get-more-gone J_scene-get-more-gone"></div></div>';else var d="";if(o)var l='<span class="gone-text">去过：'+o+"</span>";else var l='<span class="gone-text"></span>';this.addParentSid=a;var p=i(['<div class="check-default-sid" id="J_city-input" parent-sid='+a+">",'<div class="select-place">','<span class="parent-title">你在<span class="parent-sname">'+e+"</span>去过哪些景点？</span>","</div>",'<div id="J_scene-list" class="scene-list">','<div class="search-scene">','<input class="search-scene-input J_search-scene-input prompt-default" id="J_search-scene-input" type="text" placeholder="搜景点" autocomplete="off">','<a class="search-scene-submit J_search-scene-submit" title="搜索" href="###"></a>',"</div>",'<div class="city-list">'+n+"</div>",'<div class="scene-bottom-list"><div class="gone-text-list">'+l+d+'</div><a href="##" class="create-new-scene">创建新地点</a></div>',"</div>",'<div class="select-bottom"><span class="selected-text">已选择<span class="selected-number J_scene-number">0</span>个地点</span><input type="button" value="添加" class="add-all J_add-all-scene"/></div>','<div style="height:1px; margin-top:-1px;clear: both;overflow:hidden;"></div>',"</div>"].join(""));p.dialog({modal:!0,closeOnEscape:!1,draggable:!1,width:780,height:450,dialogClass:"dialog-check-sid",close:function(){i(this).remove()}}),this.result=[],this.sug&&(this.sug=null),this.sug=new r({ele:i("#J_search-scene-input")[0],sid:a,layer:[5,6]}),this.sug.init({onconfirm:function(t){var e=t.data;if(void 0!=e.index&&null!=e.index){e=s.sug.sugData[e.index],s.result.push({sid:e.sid,sname:e.sname});var a=i(".city-list .J_scene-status[data-sid="+e.sid+"]");a.addClass("scene-click").prependTo(i(".city-list"));var n=parseInt(i(".J_scene-number").html(),10);i(".J_scene-number").html(n+1)}}}),this.sugData=this.sug.sugData}};a.exports=f});
;define("user:widget/footprint-map/footprint-map.js",function(t,e,i){var n=t("common:widget/ui/jquery/jquery.js"),a=t("user:widget/ui/drawer/drawer.js"),s=t("user:widget/ui/mercatorProjection/mercatorProjection.js"),r=(t("common:widget/ui/jq-dialog/jq-dialog.js"),t("common:widget/ui/share/share.js")),o=t("common:widget/ui/login/login.js"),c=t("user:widget/ui/city-suggestion/city-suggestion.js"),l=t("user:widget/ui/updateData/updateData.js"),d=t("common:widget/ui/nslog/nslog.js");t("common:widget/ui/jquery-ext/jquery-ext.js");var p=t("person"),h=t("user"),u=t("usercenter"),f={init:function(t,e){this.dataList={},this.cityNumber=n(".number-city"),this.countryNumber=n(".number-country"),this.provinceNumber=n(".number-province"),this.sceneNumber=n(".number-scene"),this.smallMap=n(".small-map"),this.tip=n(".tip-title"),this.chinaList=t,this.worldList=e,this.projection=new s,this.pathObject={},this.alien=0,this.mapContentWorld=n(".map-content-world"),this.mapContentChina=n(".map-content-china"),this.nineSection=n(".nine-section"),this.isClick=!0,this.center={lat:3260044.23,lng:12358777.03},this.size={width:1025,height:924},this.times=1,this.initChinaMap(),u.footprintEvent&&this.bindEvent()},initChinaMap:function(){var t=this,e=new a(t.mapContentChina);if(this.draw=e.init(),this.shapes=e.chinamap.shapes,this.ids=e.chinamap.ids,Modernizr.rgba)var i={fillcolor:"rgba(0, 0, 0, 0.15)",strokecolor:"rgba(255,255, 255, 0.2)",strokeweight:1.5,style:"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);",cursor:"pointer"},s={x:0,y:0,"font-family":"Verdana","font-size":"12",fill:"rgba(0, 0, 0, 0.35)",times:this.times,style:"pointer-events: none;"};else var i={fillcolor:"#77659d",strokecolor:"#9789bf",strokeopacity:1,style:"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:0.5",cursor:"pointer"},s={x:0,y:0,"font-family":"Verdana","font-size":"12",fill:"#9789bf",times:this.times,style:"pointer-events: none;"};for(var r in this.shapes){var c=this.makeShape(r,t.shapes);i.d=c,i.province_sid=this.ids[r],i.sname=r;var l=this.draw.addLine(i);this.pathObject[r]=l,p.is_myself?this.draw.addAction(l,"click",function(e){d.nslog(window.location.href,511,{cmd:"click",pos:"add-footprint-map-myself"}),t.alien=0,t.getPathData(e)}):this.draw.addAction(l,"click",function(){o.check(function(){location.href="/user/footprint/"+h.uid})});var u=this.getPosition(l);if(s.y=u.top,s.x=u.left,this.draw.addText){this.draw.addText(r,s)}}t.mapContentChina.find(".path").each(function(t,e){setTimeout(function(){e.style.position="absolute"},1)}),t.mapContentChina.find(".title-sname").each(function(t,e){setTimeout(function(){e.style.position="absolute"},1)});var f=[];n(t.chinaList).each(function(e,i){t.draw.setAttribute(t.pathObject[i.parent_sname],"fillcolor","#ffdd00"),t.draw.setAttribute(t.pathObject[i.parent_sname],"strokecolor","#d39f02"),t.draw.setAttribute(t.pathObject[i.parent_sname],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:1");var a=n(t.pathObject[i.parent_sname]).next();"text"==n(a).attr("class")&&t.draw.setAttribute(n(a)[0],"fillcolor","rgba(0, 0, 0, 0.9)"),n(i.dest_list).each(function(t,e){if(e.map_x&&e.map_y){var i={lat:e.map_y,lng:e.map_x,sname:e.sname};f.push(i)}})}),this.drawMarker(f)},initWorldMap:function(){var t=this,e={margin:"100px 0 0 0"},i=new a(t.mapContentWorld,e);if(t.worldDrawer=i.init(),this.worldshapes=i.worldmap.shapes,this.worldnames=i.worldmap.names,this.continents=i.worldmap.continents,this.countries=i.worldmap.countries,this.worldids=i.worldmap.ids,Modernizr.rgba)var e={fillcolor:"rgba(0, 0, 0, 0.15)",strokecolor:"rgba(255,255, 255, 0.2)",strokeweight:1.5,style:"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);",cursor:"pointer"};else var e={fillcolor:"#77659d",strokecolor:"#9789bf",strokeopacity:1,style:"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:0.5",cursor:"pointer"};for(var s in this.worldshapes){var r=this.makeShape(s,t.worldshapes);e.d=r,e.continent_sid=this.continents[s],e.country_sid=this.countries[s],e.is_alien=t.alien;var c=this.worldDrawer.addLine(e);p.is_myself?this.worldDrawer.addAction(c,"click",function(e){d.nslog(window.location.href,511,{cmd:"click",pos:"add-footprint-map-myself"}),t.alien=1,t.getPathData(e)}):this.worldDrawer.addAction(c,"click",function(){o.check(function(){location.href="/user/footprint/"+h.uid})}),this.pathObject[this.countries[s]]=c}if(t.mapContentWorld.find(".path").each(function(t,e){setTimeout(function(){e.style.position="absolute"},10)}),this.chinaList){var l=this.chinaList.length;l>0&&(t.worldDrawer.setAttribute(t.pathObject["9cf3f47a261257ae7e7e5df5"],"fillcolor","#ffdd00"),t.worldDrawer.setAttribute(t.pathObject["9cf3f47a261257ae7e7e5df5"],"strokecolor","#d39f02"),t.worldDrawer.setAttribute(t.pathObject["9cf3f47a261257ae7e7e5df5"],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:1"),t.worldDrawer.setAttribute(t.pathObject["5007715ac511463263cfd1f3"],"fillcolor","#ffdd00"),t.worldDrawer.setAttribute(t.pathObject["5007715ac511463263cfd1f3"],"strokecolor","#d39f02"),t.worldDrawer.setAttribute(t.pathObject["5007715ac511463263cfd1f3"],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:1"))}var u=[];n(t.worldList).each(function(e,i){t.worldDrawer.setAttribute(t.pathObject[i.parent_sid],"fillcolor","#ffdd00"),t.worldDrawer.setAttribute(t.pathObject[i.parent_sid],"strokecolor","#d39f02"),t.worldDrawer.setAttribute(t.pathObject[i.parent_sid],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:1");var a=n(t.pathObject[i.parent_sid]).next();"text"==n(a).attr("class")&&t.worldDrawer.setAttribute(n(a)[0],"fillcolor","rgba(0, 0, 0, 0.9)"),n(i.dest_list).each(function(t,e){if(e.map_x&&e.map_y){var i={lat:e.map_y,lng:e.map_x,sname:e.sname};u.push(i)}})}),this.drawWorldMarker(u)},getPosition:function(t){var e="string"==typeof t?document.getElementById(t):t;if(null===e.parentNode)return!1;var i={top:n(e).position().top-n(e.parentNode).position().top,left:n(e).position().left-n(e.parentNode).position().left};return n.browser.mozilla&&(i={top:n(e).position().top-n(".footprint-map").position().top,left:n(e).position().left-n(".footprint-map").position().left}),i},bindEvent:function(){var t=this;n(document).delegate(".add-footprint-other","click",function(){o.check(function(){location.href="/user/footprint/"+h.uid,d.nslog(window.location.href,511,{cmd:"click",pos:"add-footprint-button-other"})})}),n(document).delegate(".small-map","click",function(){"-230px 0px"==n(this).css("backgroundPosition")||"-230px"==n(this).css("backgroundPositionX")?(t.alien=1,n(this).css("backgroundPosition","0 0"),0==t.mapContentWorld.find(".path").length?(t.initWorldMap(),t.mapContentWorld.show(),t.mapContentChina.hide(),t.nineSection.hide()):(t.mapContentChina.hide(),t.mapContentWorld.show(),t.nineSection.hide())):(t.alien=0,n(this).css("backgroundPosition","-230px 0px"),t.mapContentChina.show(),t.mapContentWorld.hide(),t.nineSection.show())}),n(document).delegate(".select-type","click",function(){var e=n(this).html();if("国内"==e)t.alien=0,n(t.smallMap).css("backgroundPosition","-230px 0"),t.mapContentChina.show(),t.mapContentWorld.hide(),n(this).addClass("selected-type"),n(this).next().removeClass("selected-type"),n(".select-continent").hide(),t.nineSection.show();else{t.alien=1,n(t.smallMap).css("backgroundPosition","0 0"),0==t.mapContentWorld.find(".path").length?(t.initWorldMap(),t.mapContentWorld.show(),t.mapContentChina.hide(),t.nineSection.hide()):(t.mapContentChina.hide(),t.mapContentWorld.show(),t.nineSection.hide()),n(this).addClass("selected-type"),n(this).prev().removeClass("selected-type");var i=n(".select-continent").html();i&&"undefined"!=i&&(n(".select-continent").show(),n(".select-continent").find("option[data-text='请选择']").attr("selected",!0))}t.getInitData(!1)}),n(document).delegate(".J_city-get-more-gone","click",function(){n(this).hasClass("get-less-gone")?(n(this).parent().parent().height(18),n(this).removeClass("get-less-gone")):(n(this).parent().parent().css("height","auto"),n(this).addClass("get-less-gone"))});var e={url:location.href,title:"",pic:"",desc:"",comment:""};n(document).delegate(".share-body a","click",function(){var t=n(this).attr("data-from");if(t){var i=r.shareComponent.testSupport(t);if(!i)return;var a=new r.shareComponent(t);a.load(),p.is_myself?d.nslog(window.location.href,511,{cmd:"click",pos:"share-map-myself"}):d.nslog(window.location.href,511,{cmd:"click",pos:"share-map-other"}),setTimeout(function(){var t={bdstoken:h.bdstoken};n.post("/user/ajax/getshareinfo",t,function(t){if(0==t.errno){var i=t.data.url;if(i)e.pic=i,e.title="我已经走过"+t.data.country+"个国家，"+t.data.city+"个城市，"+t.data.scenes+"个地方。"+100*t.data.win_percent+"%的小伙伴在我身后。我们的征途，当是星辰大海，继续上路！",a.init(e),a.exec();else{var s=n(['<div class="unshare-content">啊哦~ 出了点问题诶~程序猿正在疯狂修复中！',"</div>"].join(""));s.dialog({modal:!0,closeOnEscape:!1,draggable:!1,width:270,height:130,dialogClass:"",close:function(){n(this).remove()},buttons:{"添加":function(){n(this).remove()}}})}}},"json")},0)}}),n(document).delegate(".share","mouseenter",function(){var t=n(".share-dropdown");t.animate({top:50,opacity:.9},{duration:100,queue:!1,complete:function(){n(this).show()}})}),n(document).delegate(".intro-ctrl","mouseleave",function(){var t=n(".share-dropdown");t.animate({top:50,opacity:0},{duration:100,queue:!1,complete:function(){n(this).hide()}})}),n(document).delegate(".select-province","change",function(){var e={is_alien:t.alien,format:"ajax",t:(new Date).getTime()};if(0==t.alien){n(".no-select-place").remove(),e.province_sid=n(this).children("option:selected").attr("data-sid"),t.sug.refresh(e.province_sid);var i=t.dataList[e.province_sid];i?t.renderData(i):n.get("/destination/ajax/getfootprintdests",e,function(i){if(0==i.errno){var n=i.data.list;n.parent_sid=e.province_sid,n.parent_sname=i.data.parent_sname,t.dataList[e.province_sid]=n,t.renderData(n)}},"json")}else{e.continent_sid=n(this).children("option:selected").attr("data-sid");var i=t.dataList[e.continent_sid];i?(t.renderCountryList(i),n(".select-continent").html(t.countryList),n(".select-continent").show()):n.get("/destination/ajax/getfootprintdests",e,function(i){if(0==i.errno){var a=i.data.list;a.parent_sid=e.continent_sid,a.parent_sname=i.data.parent_sname,t.dataList[e.continent_sid]=a,t.renderCountryList(a),n(".select-continent").html(t.countryList),n(".select-continent").show()}},"json")}}),n(document).delegate(".select-continent","change",function(){var e={is_alien:t.alien,format:"ajax",t:(new Date).getTime(),country_sid:n(this).children("option:selected").attr("data-sid")};n(".no-select-place").remove();var i=t.dataList[e.country_sid];i?(t.renderData(i),n(this).show()):n.get("/destination/ajax/getfootprintdests",e,function(i){if(0==i.errno){var a=i.data.list;a.parent_sid=e.country_sid,a.parent_sname=i.data.parent_sname,t.dataList[e.country_sid]=a,t.renderData(a),n(this).show()}},"json")}),n(document).delegate(".add-footprint","click",function(){d.nslog(window.location.href,511,{cmd:"click",pos:"add-footprint-button-myself"}),t.getInitData(0==n("#J_scene-input").length?!0:!1)}),n(document).delegate(".create-new-place","click",function(e){if(e.preventDefault(),0==t.alien)var i=n(".select-province option:selected").text();else var i=n(".select-continent option:selected").text();if("请选择"==i||""==i){var a=n(".no-select-place");return void(0==a.length&&n(".select-place").append("<div class='no-select-place'>请先选择地区</div>"))}var s=n(this).offset().left-n(window).scrollLeft()-210,r=n(this).offset().top-n(window).scrollTop()-175,o=n(['<div class="create-content"><label for="scene-name" class="scene-text">城市名称：</label>','<input type="text" id="scene-name">','<span class="scene-belong">所属：'+i+"</span>",'<span class="add-tip">哦~你好像还没有添加内容啊</span>',"</div>"].join(""));o.dialog({modal:!0,closeOnEscape:!1,draggable:!1,width:270,height:170,position:[s,r],dialogClass:"",close:function(){n(this).remove()},buttons:{"添加":function(){var e=n("#scene-name").val(),i=this;if(e){if(0==t.alien)var a=1;else var a=0;var s={sname:e,parent_sid:t.addParentSid,scene_layer:4,is_china:a,bdstoken:h.bdstoken};d.nslog(window.location.href,511,{cmd:"click",pos:"add-city-scene"}),n.post("/user/ajax/adduserscene",s,function(t){if(0==t.errno){var a='<a href="##" class="go-status J_city-status scene-click" data-sid='+t.data.data.sid+" title="+n.string.encodeHTML(e)+">"+n.string.encodeHTML(e)+"</a>";n(".city-list").prepend(a);var s=parseInt(n(".J_city-number").html(),10);n(".J_city-number").html(s+1),n(i).remove()}},"json")}else n(".add-tip").show()}}})}),n(document).delegate(".J_city-status","click",function(t){var e=n(".scene-click").length;n(this).toggleClass("scene-click"),t.preventDefault();var i=n(".scene-click").length,a=i-e,s=parseInt(n(".J_city-number").html(),10);n(".J_city-number").html(s+a)}),n(document).delegate(".J_add-all-city","click",function(e){e.preventDefault();var i=n("#J_scene-input").find(".scene-click"),a=[];n(i).each(function(t,e){a.push(n(e).attr("data-sid"))});var s={sids:a,bdstoken:h.bdstoken};0!=a.length&&n.post("/footprint/post/save?format=ajax",s,function(e){if(0==e.errno){n("#J_scene-input").remove();var i=e.data;i.alien=t.alien;var a=[];if(0==t.alien)var s=3;else var s=2;n(i.list).each(function(t,e){parseInt(e.scene_layer,10)==s?(i.parent_sid=e.sid,i.parent_sname=e.sname,spliceIndex=t):parseInt(e.scene_layer,10)>s&&a.push(e)}),0==t.alien&&(i.parent_sid||n(a).each(function(t,e){4==e.scene_layer&&(i.parent_sid=e.sid,i.parent_sname=e.sname)}));var r=t.dataList[i.parent_sid];n(r).each(function(t,e){n(a).each(function(t,i){i.sid==e.sid&&(e.is_gone=1)})}),i.list=a,l.add(i)}},"json")}),n(l).on("add",function(e,i){t.addNumber(i),t.addMapList(i)}),n(l).on("deleteCity",function(e,i){t.deleteNumber(i),t.deleteMapList(i)}),n(l).on("deleteScene",function(){t.deleteSceneNumber()}),n(l).on("addScene",function(e,i){t.addSceneNumber(i)})},renderData:function(t){var e="",i="",a=this;a.addParentSid=t.parent_sid,n(t).each(function(t,n){n.is_gone?i+="<a href='##' class='gone-status'>"+n.sname+"</a>":e+="<a href='##' class='go-status J_city-status' data-sid='"+n.sid+"' title="+n.sname+">"+n.sname+"</a>"}),e=e||"请选择一个地区",n(".city-list").html(e),n(".gone-text").html(i?"去过："+i:""),n(".J_city-number").html(0)},getInitData:function(t){var e=this,i={is_alien:e.alien,format:"ajax",t:(new Date).getTime()};if(e.isClick)if(e.continentSid="请选择",e.isClick=!1,0==e.alien){var a=e.dataList.province;a?(t?e.renderArea("",e.provinceStr):n(".select-province").html(e.provinceStr),n(".city-list").html("请选择一个地方"),e.isClick=!0):n.get("/destination/ajax/getfootprintdests",i,function(i){if(0==i.errno){var a=i.data.list;a.parent_sid="",a.parent_sname="请选择",e.dataList.province=a,e.provinceStr="<option class='opt-select' value='-1' data-text='请选择'>请选择</option>",n(a).each(function(t,i){e.provinceStr+="<option class='opt-select' value="+t+" data-text="+i.sname+" data-sid="+i.sid+">"+i.sname+"</option>"}),t?e.renderArea("",e.provinceStr):n(".select-province").html(e.provinceStr),n(".city-list").html("请选择一个地方"),e.isClick=!0}},"json")}else{var a=e.dataList.foreign;a?(t?e.renderArea("",e.foreignStr):n(".select-province").html(e.foreignStr),n(".city-list").html("请选择一个地方"),e.isClick=!0):n.get("/destination/ajax/getfootprintdests",i,function(i){if(0==i.errno){var a=i.data.list;a.parent_sid="",a.parent_sname="请选择",e.dataList.foreign=a,e.foreignStr="<option class='opt-select' value='-1' data-text='请选择'>请选择</option>",n(a).each(function(t,i){e.foreignStr+="<option class='opt-select' value="+t+" data-text="+i.sname+" data-sid="+i.sid+">"+i.sname+"</option>"}),t?e.renderArea("",e.foreignStr):n(".select-province").html(e.foreignStr),n(".city-list").html("请选择一个地方"),e.isClick=!0}},"json")}},getPathData:function(t){var e=this,i=t.target,a={is_alien:e.alien,format:"ajax",t:(new Date).getTime()};if(n(i).attr("province_sid")||n(i).attr("continent_sid")||(i=n(i).parent().prev()),e.isClick)if(e.isClick=!1,0==e.alien){var s=n(i).attr("province_sid"),r=(n(i).attr("sname"),e.dataList.province),o=e.dataList[s];n(".select-continent").hide(),r?o?(e.renderArea(o,e.provinceStr),e.isClick=!0):(a.province_sid=s,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.province_sid,i.parent_sname=t.data.parent_sname,e.dataList[a.province_sid]=i,e.renderArea(i,e.provinceStr),e.isClick=!0}},"json")):n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;e.provinceStr="<option class='opt-select' value='-1' data-text='请选择'>请选择</option>",n(i).each(function(t,i){e.provinceStr+="<option class='opt-select' value="+t+" data-text="+i.sname+" data-sid="+i.sid+">"+i.sname+"</option>"}),e.dataList.province=i,o?e.renderArea(o,e.provinceStr):(a.province_sid=s,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.province_sid,i.parent_sname=t.data.parent_sname,e.dataList[a.province_sid]=i,e.renderArea(i,e.provinceStr),e.isClick=!0}},"json"))}},"json")}else{var c=n(i).attr("continent_sid"),l=n(i).attr("country_sid"),d=e.dataList.foreign,o=e.dataList[l];continent_data_content=e.dataList[c],d?continent_data_content?(e.renderCountryList(continent_data_content),o?(e.renderArea(o,e.foreignStr),n(".select-continent").show(),e.isClick=!0):(a.country_sid=l,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.province_sid,i.parent_sname=t.data.parent_sname,e.dataList[a.province_sid]=i,e.renderArea(i,e.foreignStr),n(".select-province").find("option[data-text='"+continent_data_content.parent_sname+"']").attr("selected",!0),n(".select-continent").show(),e.isClick=!0}},"json"))):(a.continent_sid=c,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.continent_sid,i.parent_sname=t.data.parent_sname;var s=e.dataList[a.continent_sid]=i;e.renderCountryList(i),o?(e.renderArea(o,e.foreignStr),n(".select-continent").show(),e.isClick=!0):(delete a.continent_sid,a.country_sid=l,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.country_sid,i.parent_sname=t.data.parent_sname,e.dataList[a.country_sid]=i,e.renderArea(i,e.foreignStr),n(".select-province").find("option[data-text='"+s+"']").attr("selected",!0),n(".select-continent").show(),e.isClick=!0}},"json"))}},"json")):n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;e.foreignStr="<option class='opt-select' value='-1' data-text='请选择'>请选择</option>",n(i).each(function(t,i){e.foreignStr+="<option class='opt-select' value="+t+" data-text="+i.sname+" data-sid="+i.sid+">"+i.sname+"</option>"}),e.dataList.foreign=i,continent_data_content?(e.renderCountryList(continent_data_content),o?(e.renderArea(o,e.foreignStr),n(".select-province").find("option[data-text='"+continent_data_content.parent_sname+"']").attr("selected",!0),n(".select-continent").show(),e.isClick=!0):(a.country_sid=l,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.province_sid,i.parent_sname=t.data.parent_sname,e.dataList[a.province_sid]=i,e.renderArea(i,e.foreignStr),n(".select-province").find("option[data-text='"+continent_data_content.parent_sname+"']").attr("selected",!0),n(".select-continent").show(),e.isClick=!0}},"json"))):(a.continent_sid=c,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.continent_sid;var s=i.parent_sname=t.data.parent_sname;e.dataList[a.continent_sid]=i,e.renderCountryList(i),o?(e.renderArea(o,e.foreignStr),n(".select-province").find("option[data-text='"+s.parent_sname+"']").attr("selected",!0),n(".select-continent").show(),e.isClick=!0):(delete a.continent_sid,a.country_sid=l,n.get("/destination/ajax/getfootprintdests",a,function(t){if(0==t.errno){var i=t.data.list;i.parent_sid=a.country_sid,i.parent_sname=t.data.parent_sname,e.dataList[a.country_sid]=i,e.renderArea(i,e.foreignStr),n(".select-province").find("option[data-text='"+s+"']").attr("selected",!0),n(".select-continent").show(),e.isClick=!0}},"json"))}},"json"))}},"json")}},renderCountryList:function(t){var e=this;e.countryList="<option class='opt-select' value='-1' data-text='请选择'>请选择</option>",n(t).each(function(t,i){e.countryList+="<option class='opt-select' value="+t+" data-text="+i.sname+" data-sid="+i.sid+">"+i.sname+"</option>"}),e.continentSid=t.parent_sid,n(".select-province").find("option[data-sid='"+t.parent_sid+"']").attr("selected",!0)},addMapList:function(t){if(0==t.alien){var e=[],i=t.parent_sname;this.draw.setAttribute(this.pathObject[i],"fillcolor","#ffdd00"),this.draw.setAttribute(this.pathObject[i],"strokecolor","#d39f02"),this.draw.setAttribute(this.pathObject[i],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:1");var a=n(this.pathObject[i]).next();"text"==n(a).attr("class")&&this.draw.setAttribute(n(a)[0],"fillcolor","rgba(0, 0, 0, 0.9)"),n(t.list).each(function(t,i){var n={lat:i.map_y,lng:i.map_x,sname:i.sname};e.push(n)}),this.drawMarker(e)}else{var e=[],s=t.parent_sid;this.worldDrawer.setAttribute(this.pathObject[s],"fillcolor","#ffdd00"),this.worldDrawer.setAttribute(this.pathObject[s],"strokecolor","#d39f02"),this.worldDrawer.setAttribute(this.pathObject[s],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:1");var a=n(this.pathObject[s]).next();"text"==n(a).attr("class")&&this.worldDrawer.setAttribute(n(a)[0],"fillcolor","rgba(0, 0, 0, 0.9)"),n(t.list).each(function(t,i){var n={lat:i.map_y,lng:i.map_x,sname:i.sname};e.push(n)}),this.drawWorldMarker(e)}},deleteMapList:function(t){var e=t.title;if(n(".img[title="+e+"]").remove(),t.parent_title)if(0==t.alien)if(Modernizr.rgba){this.draw.setAttribute(this.pathObject[t.parent_title],"fillcolor","rgba(0, 0, 0, 0.15)"),this.draw.setAttribute(this.pathObject[t.parent_title],"strokecolor","rgba(255, 255, 255, 0.2)"),this.draw.setAttribute(this.pathObject[t.parent_title],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);");var i=n(this.pathObject[t.parent_title]).next();"text"==n(i).attr("class")&&this.draw.setAttribute(n(i)[0],"fillcolor","rgba(0, 0, 0, 0.35)")}else this.draw.setAttribute(this.pathObject[t.parent_title],"fillcolor","#77659d"),this.draw.setAttribute(this.pathObject[t.parent_title],"strokecolor","#9789bf"),this.draw.setAttribute(this.pathObject[t.parent_title],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:0.5");else if(Modernizr.rgba){this.worldDrawer.setAttribute(this.pathObject[t.parent_sid],"fillcolor","rgba(0, 0, 0, 0.15)"),this.worldDrawer.setAttribute(this.pathObject[t.parent_sid],"strokecolor","rgba(255, 255, 255, 0.2"),this.worldDrawer.setAttribute(this.pathObject[t.parent_sid],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);");var i=n(this.pathObject[t.parent_sid]).next();"text"==n(i).attr("class")&&this.worldDrawer.setAttribute(n(i)[0],"fillcolor","rgba(0, 0, 0, 0.35)")}else this.worldDrawer.setAttribute(this.pathObject[t.parent_sid],"fillcolor","#77659d"),this.worldDrawer.setAttribute(this.pathObject[t.parent_sid],"strokecolor","#9789bf"),this.worldDrawer.setAttribute(this.pathObject[t.parent_sid],"style","-webkit-tap-highlight-color: rgba(0, 0, 0, 0);opacity:0.5")},renderArea:function(t,e){var i="",a="",s=this,r=0;if(n(t).each(function(t,e){e.is_gone?(r+=e.sname.length,a+="<a href='##' class='gone-status'>"+e.sname+"</a>"):i+="<a href='##' class='go-status J_city-status' data-sid='"+e.sid+"' title="+e.sname+">"+e.sname+"</a>"}),r>30)var o='<div class="get-more"><div class="get-more-gone J_city-get-more-gone"></div></div>';else var o="";if(i=i||"请选择一个地区",0==s.alien)var l='<a class="select-type selected-type">国内</a><a class="select-type">国外</a>';else var l='<a class="select-type">国内</a><a class="select-type selected-type">国外</a>';if(a)var d="<span class='gone-text'>"+a+o+"</span>";else var d="<span class='gone-text'></span>";this.addParentSid=t.parent_sid,this.content=n(['<div class="check-default-sid" id="J_scene-input" parent-sid='+t.parent_sid+" parent-sname="+t.parent_sname+">",'<div class="select-place">',l,'<select class="select-province">'+e+"</select>",'<select class="select-continent">'+s.countryList+"</select>","</div>",'<div class="search-scene-container" style="display:none">','<input class="search-scene-input J_search-scene-input prompt-default" id="J_search-scene-input" type="text" placeholder="搜景点" autocomplete="off">','<a class="search-scene-submit J_search-scene-submit" title="搜索" href="###"></a>',"</div>",'<div id="J_scene-list" class="scene-list"><div class="city-list">'+i+"</div>",'<div class="scene-bottom-list"><div class="gone-text-list">'+d+'</div><a href="##" class="create-new-place">创建新地点</a></div>',"</div>",'<div class="select-bottom"><span class="selected-text">已选择<span class="selected-number J_city-number">0</span>个地点</span><input type="button" value="添加" class="add-all J_add-all-city"/></div>','<div style="height:1px; margin-top:-1px;clear: both;overflow:hidden;"></div>',"</div>"].join("")),this.content.dialog({title:"踩足迹",modal:!0,closeOnEscape:!1,draggable:!1,width:780,height:440,dialogClass:"dialog-check-sid",close:function(){n(this).remove()}}),s.result=[],this.sug&&(this.sug=null),this.sug=new c({ele:n("#J_search-scene-input")[0],sid:t.parent_sid,layer:[4]}),this.sug.init({onconfirm:function(t){var e=t.data;if(void 0!=e.index&&null!=e.index){e=s.sug.sugData[e.index],s.result.push({sid:e.sid,sname:e.sname});var i=n(".city-list .J_city-status[data-sid="+e.sid+"]");i.addClass("scene-click").prependTo(n(".city-list"));var a=parseInt(n(".J_city-number").html(),10);n(".J_city-number").html(a+1)}}}),this.sugData=this.sug.sugData,0==s.alien?n(".select-province").find("option[data-text='"+t.parent_sname+"']").attr("selected",!0):(n(".select-province").find("option[data-sid='"+s.continentSid+"']").attr("selected",!0),n(".select-continent").find("option[data-text='"+t.parent_sname+"']").attr("selected",!0))},makeShape:function(t,e){var i=this,a=[],s=e[t];return n(s).each(function(t,e){var s=0,r=0;a[t]=[];var o=e.split("M");o.pop(),n(o).each(function(e,n){var o=n.split(",");s+=o[0]*i.times,r+=o[1]*i.times,a[t].push({x:s,y:r})})}),a},drawWorldMarker:function(t){var e=this,i={lat:10605386.93,lng:-2779755.75},a={width:1167,height:500};n(t).each(function(t,n){var s={lat:n.lat,lng:n.lng};if(0!=n.lat||0!=n.lng){var r=e.projection.pointToPixel(s,3,i,a),o=(r.x-5)/1167*857*e.times,c=(r.y-285)/500*380*e.times;if(20>=c)var c=(r.y-220)/500*380;else if(c>20&&c<=40*e.times)var c=(r.y-240-c/10)/500*380*e.times;else if(c>40&&c<=100*e.times)var c=(r.y-265-c/10)/500*380*e.times;else if(c>100&&150>c)var c=(r.y-280)/500*380*e.times;else if(c>=150&&200>c)var c=(r.y-280)/500*380*e.times;else if(c>=200&&250>c)var c=(r.y-280)/500*380*e.times;else if(c>=250&&300>c)var c=(r.y-280)/500*380*e.times;else if(c>=300&&350>c)var c=(r.y-280)/500*380*e.times;if(170>=o)var o=(r.x-80)/1167*857*e.times;else if(o>170&&200>=o)var o=(r.x-65)/1167*857*e.times;else if(o>200&&300>=o)var o=(r.x-60)/1167*857*e.times;else if(o>300&&350>=o)var o=(r.x-55)/1167*857*e.times;else if(o>350&&400>=o)var o=(r.x-50)/1167*857*e.times;else if(o>400&&450>=o)var o=(r.x-35)/1167*857*e.times;else if(o>450&&500>=o)var o=(r.x-33)/1167*857*e.times;else if(o>500&&550>=o)var o=(r.x-25)/1167*857*e.times;else if(o>550&&600>=o)var o=(r.x-20)/1167*857*e.times;else if(o>800&&900>=o)var o=(r.x+5)/1167*857*e.times;var l={x:o*e.times-11,y:c*e.times-20,r:4,height:20,width:22,title:n.sname},d="http://lvyou3.bdimg.com/static/user/widget/footprint-map/img/marker-img_7ae4e9d.png",p=e.worldDrawer.addImg(d,l);e.worldDrawer.addAction(p,"mouseenter",function(t){e.linkOnMouseOver(n.sname,t.target)}),e.worldDrawer.addAction(p,"mouseleave",function(){e.linkOnMouseOut()})}}),this.mapContentWorld.find(".img").each(function(t,e){setTimeout(function(){e.style.position="absolute"},1)})},drawMarker:function(t){var e=this;n(t).each(function(t,i){var n={lat:i.lat,lng:i.lng};if(0!=i.lat||0!=i.lng){var a=e.projection.pointToPixel(n,5,e.center,e.size),s={x:a.x*e.times-11,y:a.y*e.times-20,height:20,width:22,title:i.sname},r="http://lvyou3.bdimg.com/static/user/widget/footprint-map/img/marker-img_7ae4e9d.png",o=e.draw.addImg(r,s);e.draw.addAction(o,"mouseenter",function(t){e.linkOnMouseOver(i.sname,t.target)}),e.draw.addAction(o,"mouseleave",function(){e.linkOnMouseOut()})}}),this.mapContentChina.find(".img").each(function(t,e){setTimeout(function(){e.style.position="absolute"},1)})},linkOnMouseOver:function(t,e){var i=n(e).parent(),a=i.find(".img"),s=parseFloat(n(e).attr("x")||n(e).position().left),r=parseFloat(n(e).attr("y")||n(e).position().top),o=(n(e).attr("title"),"<div class='total-title'>"),c=0;n(a).each(function(t,e){var i=parseFloat(n(e).attr("x")||n(e).position().left),a=parseFloat(n(e).attr("y")||n(e).position().top);if(Math.abs(i-s)<10&&Math.abs(a-r)<10){c++;var l=n(e).attr("title");o+="<span class='title-content'>"+l+"</span>"}}),o+="</div>",o="<div class='info-arrow' style='border-width:"+9*c+"px 13px "+9*c+"px 0'></div>"+o,this.tip.css("display","block"),this.tip.css("top",r-5*c+5),this.tip.css("left",s+15),this.tip.html(o)},linkOnMouseOut:function(){this.tip.css("display","none")},addNumber:function(t){var e=t.parent_sname,i=t.parent_sid;if(0==this.alien){var a=n(this.pathObject[e]).attr("fill");if("#77659d"==a||"rgba(0, 0, 0, 0.15)"==a){var s=parseInt(this.provinceNumber.html(),10);this.provinceNumber.html(s+1)}var r=parseInt(this.cityNumber.html(),10);this.cityNumber.html(r+t.list.length-1)}else{var a=n(this.pathObject[i]).attr("fill");if("#77659d"==a||"rgba(0, 0, 0, 0.15)"==a){var o=parseInt(this.countryNumber.html(),10);this.countryNumber.html(o+1)}var s=parseInt(this.provinceNumber.html(),10);this.provinceNumber.html(s+t.list.length-1)}},deleteNumber:function(t){if(t.parent_title&&t.title){var e=parseInt(this.provinceNumber.html(),10);e>0&&this.provinceNumber.html(e-1)}var i=parseInt(this.cityNumber.html(),10);i>0&&this.cityNumber.html(i-1);var n=parseInt(this.sceneNumber.html(),10);n>=t.scene_length&&this.sceneNumber.html(n-t.scene_length)},deleteSceneNumber:function(){var t=parseInt(this.sceneNumber.html(),10);t>0&&this.sceneNumber.html(t-1)},addSceneNumber:function(t){var e=parseInt(this.sceneNumber.html(),10);this.sceneNumber.html(e+t.list.length)}};i.exports=f});
;define("user:widget/notes/notes.js",function(n,t,e){var o=n("common:widget/ui/jquery/jquery.js"),i=n("common:widget/ui/dialog/dialog.js"),s=n("usercenter"),d={init:function(){s.notesEvent&&(this.bindEvent(),s.notesEvent=0)},bindEvent:function(){var n=this;o(".nodes-list").click(function(t){var e=t.target;o(e).hasClass("delet")&&n.delet(o(e).attr("data-nid"))})},delet:function(t){var e={nid:t,bdstoken:n("user").bdstoken};i.confirm("你确定要删除该游记吗？<br />如果删掉的话，当年的奖金会被要回来的T_T",{onaccept:function(){o.post("/notes/delete?format=ajax",e,function(n){0===n.errno&&location.reload()},"json")}})}};e.exports=d});
;define("user:widget/message/message.js",function(e,t,a){var s=e("common:widget/lib/tangram/base/base.js"),n=e("common:widget/ui/jquery-ext/jquery-ext.js"),i=e("common:widget/ui/countback/countback.js"),m=e("common:widget/ui/tokenCheck/tokenCheck.js"),r=e("common:widget/ui/dialog/dialog.js"),o=e("common:widget/ui/errno/errno.js"),u=e("usercenter"),l={msgInfo:[],user:e("user")},c={init:function(){var e=this;this.dataFormat(),u.messageEvent&&(n(document).click(function(t){var a=t.target;n(a).hasClass("J_reply")&&e.taggleComment(a,n(a).attr("data-msgid")),n(a).hasClass("J_reply-submit")&&(e.handle_flag=!1,e.submit(a,n(a).attr("data-msgid")))}),u.messageEvent=0)},dataFormat:function(){var t=this;this.msgData={},l.msgInfo=e("msgInfo").data,n(l.msgInfo).each(function(e,a){var i=t.msgData[a.msg_id]=a.content;switch(i.msg_type=a.msg_type,i.tpl="#{content}",a.msg_type){case 11:i.submitUrl="/notes/post/submit";var m=n("#J_notes-content-"+a.msg_id).html();i.tpl='<div class="qoute-content"><div class="inner-qoute-content"><blockquote>'+m+'</blockquote><div class="qoute-detail"><span class="qoute-user"><a target="_blank" href="/user/'+i.user.uid+'">'+i.user.nickname+'</a></span><span class="qoute-time">发表于'+s.date.format(new Date,"yyyy-MM-dd HH:mm")+"</span></div></div></div><p><br /></p><p>#{content}<br /></p>",i.submitData={nid:i.from.nid,pid:i.pid};break;case 12:i.submitUrl="/pictravel/comment/pictravelsave?format=ajax",i.maxNum=300,i.submitData={ptid:i.from.ptid,puid:"",reply_id:i.reply_id};break;case 13:i.submitUrl="/pictravel/comment/picsave?format=ajax",i.maxNum=300,i.submitData={ptid:i.from.ptid,puid:i.from.puid,reply_id:i.reply_id};break;case 14:i.submitUrl="/user/comment/save",i.maxNum=200,i.submitData={uid:l.user.uid,re_uid:i.user.uid,re_uname:i.user.uname,re_content:i.content};break;case 15:i.submitUrl="/user/ajax/remark/addcomment",i.maxNum=300,i.submitData={reply_uid:i.user.uid,reply_id:i.reply_id,remark_id:i.from.remark_id,content:i.content};break;case 17:i.submitUrl="/plan/ajax/comments/add?format=ajax",i.maxNum=300,i.submitData={reply_id:i.rid,pl_id:i.pl_id,content:i.content}}})},submit:function(e,t){if(!n(e).hasClass("submit-disabled")){var a=n(e).parents("li"),i=n(".J_comment-input",a)[0],u=n(".J_comment-box",a),c=!1,d=this.msgData[t],p=this;if(c)var b=new m({container:u});var g=n(".J_comment-input",a)[0].value,f=s.string.getByteLength(g)/2,_={};if(0===f)return void r.splash("请填写回复内容",{iconStyle:"alert"});if(d.maxNum&&f>d.maxNum)return void r.splash("请不要超过"+maxNum+"字",{iconStyle:"alert"});c&&(_=b.checkVcode()),p.handle_flag||(p.handle_flag=!0,c&&s.object.isEmpty(_)||(g=n.string.format(d.tpl,{content:g}),_.content=g,_.bdstoken=l.user.bdstoken,n.extend(d.submitData,_),n.post(d.submitUrl,d.submitData,function(e){0===e.errno?void 0!==e.data.is_reply_deleted&&1===parseInt(e.data.is_reply_deleted,10)?r.alert("此评论已经被它的主人遗弃了，没办法回复啦~"):(r.splash("回复成功！",{iconStyle:"success"}),i.value="",n(u).hide(400)):214==e.errno?c=!0:217===e.errno?r.alert("啊哦，您填写了不符合天朝朝纲的内容啦。请检查修改之后重新提交~"):200===e.errno?r.alert("这篇文章已经被它的主人遗弃了，没办法评论啦~"):o.check(e),handle_flag=!1},"json")))}},taggleComment:function(e,t){var a=this.msgData[t],s=n(e).parents("li"),m=n(".J_comment-box",s),r=n(".J_comment-input",s)[0],o=n(".J_comment-num",s);if("none"===m.css("display")){r.value||(r.value=n(r).attr("defaultValue")),n(m).show("slow/400/fast").focus();var u=r.value.length;if(document.selection){var l=r.createTextRange();l.moveStart("character",u),l.collapse(),l.select()}else"number"==typeof r.selectionStart&&"number"==typeof r.selectionEnd&&(r.selectionStart=r.selectionEnd=u)}else n(m).hide("slow/400/fast");a.maxNum&&(n(".J_max-num",m).html("/"+a.maxNum),o.html("0"),i.countback(r,{numberContainer:o[0],max:a.maxNum,gbk:!0,defaultColor:"rgba(255,255,255,.4)",alertColor:"red",onfail:function(){n(".J_reply-submit",s).addClass("submit-disabled")},onsuccess:function(){n(".J_reply-submit",s).removeClass("submit-disabled")}}))}};a.exports=c});
;define("user:widget/channel/channel.js",function(e,t,a){var n=e("common:widget/ui/jquery/jquery.js"),s=e("common:widget/ui/login/login.js"),i=e("common:widget/ui/lite/lite.js"),r=e("common:widget/lib/tangram/ui/Pager/Pager.js"),o=e("user");e("common:widget/ui/jquery-ext/jquery-ext.js");var c=e("common:widget/ui/eJS/eJS.js"),l={init:function(){var e=this;this.counts=0,this.saveContent=n("#J-save-content"),this.tip=n("#J-reply-count"),this.renderChannelList=new c({url:"/static/user/widget/channel/channel.ejs"}),this.chinaMap=n(".footprint-china-map"),this.worldMap=n(".footprint-world-map");var t={rn:8,bdstoken:o.bdstoken||0};n.post("/main/event/letsgo/getcommentlist?thread=footprint&format=ajax",t,function(t){if(0==t.errno){var a=t.data.comment_list,s="<tr>",i=e._expressions=t.data.expression;n(i).each(function(e,t){s+='<td><a title="'+t.desc+'" data-action="expression" data-expression="'+t.desc+'" href="###" class="face face-'+e+'"></a></td>',(e+1)%10==0&&(s+="</tr><tr>")}),s+="</tr>",n(".expression-container tbody").append(s);var r=parseInt(t.data.total_count),o=8,c=parseInt(Math.ceil(r/o));c>1&&e.pagerHandle(c),e.pushlist(a)}},"json"),o.is_login&&this.reloadPic(),this.bindEvent(),this.renderChannelPager(10)},reloadPic:function(){var e=this;n.get("/user/ajax/getuserfootprint",function(t){if(0==t.errno){var a=t.data;if(a.pic_world)var n=i.createImage("",a.pic_world,612,602,128,95,!0,!1);else var s="http://lvyou4.bdimg.com/static/user/img/no-pic-footprint_e5c1d85.png",n='<img src="'+s+'"/>';if(a.pic_china)var r=i.createImage("",a.pic_china,612,602,128,95,!0,!1);else var s="http://lvyou4.bdimg.com/static/user/img/no-pic-footprint_e5c1d85.png",r='<img src="'+s+'"/>';e.chinaMap.html(r),e.worldMap.html(n)}},"json")},pagerHandle:function(e){var t=this;this.pager=new r({beginPage:1,endPage:e,currentPage:1,itemCount:5,tplLabel:"#{page}",ongotopage:function(e){t.update.call(t,e.page)},element:"pagerBox",autoRender:!0,leftItemCount:2})},update:function(e){var t=this,a={pn:8*(e-1),rn:8,bdstoken:o.bdstoken||0};n.post("/main/event/letsgo/getcommentlist?thread=footprint&format=ajax",a,function(e){if(0==e.errno){var a=e.data.comment_list,s=parseInt(e.data.total_count),i=8,r=parseInt(Math.ceil(s/i));r>1&&t.pager.update(r),n(".list1").html(""),t.pushlist(a)}},"json")},pushlist:function(e){var t=this,a="";n(e).each(function(e,s){var r="",c=new Date,l=new Date(1e3*parseInt(s.create_time)),d="",u="";r=c.getDate()==l.getDate()?"(今天"+i.date("H:i:s",s.create_time)+")":"("+i.date("m-d",s.create_time)+")",s.uid!=o.uid&&(d='<a class="J-replyMessage" data-id="'+s.uid+'" data-name="'+s.uname+'">回复</a>'),(s.uid==o.uid||1==o.is_admin)&&(u='<a class="J-deleteMessage" data-id="'+s.reply_id+'">删除</a>'),a+='<li class="clearfix message-content"><div class="fl uhead"><a href="/user/'+s.uid+'" target="_blank" class=""><img src='+i.getUserAbHead(s.avatar_small,s.avatar_source)+' class="usercard">'+s.uname+'</a></div><div class="fl umessage"><span class="reply-content fl">'+t.translate(n.string.encodeHTML(s.content))+'</span><div class="fr retool"><span class="comment-time">'+r+"</span>"+u+d+"</div></div></li>"}),n(".list1").append("<span id='J-list-top'></span><ul class='messagelist' id='J-messagelist'>"+a+"</ul>")},translate:function(e){var t=/\[[\u4e00-\u9fa5]+\]/g,a=this._expressions;return e=e.replace(t,function(e){for(var t=e.substring(1,e.lastIndexOf("]")),n=0,s=a.length;s>n;n++)if(a[n].desc==t)return"<div class='face-content face-"+n+"'></div>";return e})},bindEvent:function(){var e=this;n(document).delegate("#expression-btn","click",function(){n("#expression-container").toggle()}),n(document).delegate("#expression-container","click",function(t){var a=t.target,s=n(a).attr("data-action");if("expression"==s){var i=n(a).attr("data-expression");n("#expression-container").hide(),e.insertText(e.saveContent[0],"["+i+"]"),e.tipWordsLen.call(e)}t.preventDefault()}),n(document).on("click",function(e){var t=e.target,a=n(t).attr("data-action");"showExpression"!=a&&n("#expression-container").hide()}),n(document).delegate(".J-replyMessage","click",function(){e.replyMessage.call(e,this)}),n(document).delegate(".J-deleteMessage","click",function(){e.deleteMessage.call(e,this)}),n(document).delegate(e.saveContent,"keyup",function(){e.tipWordsLen.call(e)}),this.saveMessage()},tipWordsLen:function(){var e=n.trim(this.saveContent.val()).length;this.counts=e,this.tip.html(e>200?'已超过<span id="J-reply-num">'+(e-200)+"</span>个字~":'您还可以输入<span id="J-reply-num">'+(200-e)+"</span>个字~")},insertText:function(e,t){if(e.focus(),document.selection){var a=document.selection.createRange();a.text=t}else if("number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd){var n=e.selectionStart,s=e.selectionEnd,i=n,r=e.value;e.value=r.substring(0,n)+t+r.substring(s,r.length),i+=t.length,e.selectionStart=e.selectionEnd=i}else e.value+=t},replyMessage:function(e){var t=this;s.check(function(){t.re_uid=n(e).attr("data-id");var a=n(e).attr("data-name"),s="回复"+a+"："+t.saveContent.val();t.saveContent.val(s),t.moveCursorToEnd(t.saveContent[0])})},deleteMessage:function(e){s.check(function(){var t=n(e).attr("data-id"),a={uid:o.uid,reply_id:t,bdstoken:o.bdstoken};n.post("/main/event/letsgo/deletecomment?thread=footprint&format=ajax",a,function(t){if(0==t.errno){var a=n(e).parents(".message-content");a.remove()}},"json")})},moveCursorToEnd:function(e){e.focus();var t=e.value.length;if(document.selection){var a=e.createTextRange();a.moveStart("character",t),a.collapse(),a.select()}else"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd&&(e.selectionStart=e.selectionEnd=t)},saveMessage:function(){var e=this;n(document).delegate("#J-save-button","click",function(){var t=this;s.check(function(){if(n(t).attr("disabled","disabled"),e.counts>0&&e.counts<=200){var a=n.trim(e.saveContent.val());if(e.re_uid)var r={uid:o.uid,content:a,bdstoken:o.bdstoken,re_uid:e.re_uid};else var r={uid:o.uid,content:a,bdstoken:o.bdstoken};n.post("/main/event/letsgo/savecomment?thread=footprint&format=ajax",r,function(r){if(n(t).removeAttr("disabled"),e.counts=0,0==r.errno){var c=r.data.reply_id,l='<li class="clearfix message-content"><div class="fl uhead"><a href="/user/'+o.uid+'" target="_blank" class=""><img src='+i.getUserAbHead(o.avatar_small,o.avatar_source)+' width="42" class="usercard" height="42"><br>'+o.uname+'</a></div><div class="fl umessage"><span class="reply-content fl">'+e.translate(n.string.encodeHTML(a))+'</span><div class="fr retool"><span>刚刚</span><a class="J-deleteMessage" data-id="'+c+'">删除</a></div></div></li>',d=n("#J-messagelist");0!=d.length?d.prepend(l):n(".list1").append("<span id='J-list-top'></span><ul class='messagelist' id='J-messagelist'>"+l+"</ul>"),e.saveContent.val(""),e.re_uid="",e.tip.html("")}else 2==r.errno?s.check():702==r.errno&&n("#J-reply-tip").html("您的留言有不恰当词汇~请修改之后再发表哦~")},"json")}else 0==e.counts?n(t).removeAttr("disabled"):e.counts>200&&n(t).removeAttr("disabled")})})},renderChannelPager:function(e){var t=this;this.channelPager=new r({beginPage:1,endPage:e,currentPage:1,itemCount:5,tplLabel:"#{page}",ongotopage:function(e){t.updateChannelList.call(t,e.page)},element:"all-msg-ft",autoRender:!0,leftItemCount:2})},updateChannelList:function(e){var t=this,a={pn:8*(e-1),rn:8,bdstoken:o.bdstoken||0};n.get("/user/ajax/footprint/getfootprintlist",a,function(e){if(0==e.errno){var a=e.data.footprint_list;n(".footprint-list-all").html("");var s="";n(a).each(function(e,a){if(a.is_world)if(a.pic_world)var n=i.createImage("",a.pic_world,612,602,310,220,!0,!1);else var r="http://lvyou4.bdimg.com/static/user/img/no-pic-footprint_e5c1d85.png",n='<img src="'+r+'"/>';else if(a.pic_china)var n=i.createImage("",a.pic_china,612,602,310,220,!0,!1);else var r="http://lvyou4.bdimg.com/static/user/img/no-pic-footprint_e5c1d85.png",n='<img src="'+r+'"/>';a.img=n,a.footprint_createtime=i.date("Y.m.d",a.create_time),a.user_src=i.getUserAbHead(a.avatar_small,a.avatar_source),a.uname_short=a.uname?a.uname.length>12?a.uname.substr(0,12)+"...":a.uname:"",s+=t.renderChannelList.render(a)}),n(".footprint-list-all").html(s)}},"json")}};a.exports=l});